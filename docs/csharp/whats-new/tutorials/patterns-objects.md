---
title: Использование шаблонов в объектах — учебник по C#
description: В этом учебнике описаны методы использования сопоставления шаблонов в элементах класса для создания лучших моделей поведения объектов
ms.date: 11/05/2020
ms.openlocfilehash: 072f6f57696504c2d691473e3a43c1cda53f227f
ms.sourcegitcommit: c7f0beaa2bd66ebca86362ca17d673f7e8256ca6
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/23/2021
ms.locfileid: "104878973"
---
# <a name="use-pattern-matching-to-build-your-class-behavior-for-better-code"></a><span data-ttu-id="d3789-103">Использование сопоставления шаблонов для создания поведения класса и улучшения кода</span><span class="sxs-lookup"><span data-stu-id="d3789-103">Use pattern matching to build your class behavior for better code</span></span>

<span data-ttu-id="d3789-104">Функции сопоставления шаблонов в C# предоставляют синтаксис для выражения алгоритмов.</span><span class="sxs-lookup"><span data-stu-id="d3789-104">The pattern matching features in C# provide syntax to express your algorithms.</span></span> <span data-ttu-id="d3789-105">Эти методы можно использовать для реализации поведения в классах.</span><span class="sxs-lookup"><span data-stu-id="d3789-105">You can use these techniques to implement the behavior in your classes.</span></span> <span data-ttu-id="d3789-106">Объектно-ориентированную архитектуру класса можно объединить с реализацией, ориентированной на данные, чтобы обеспечить лаконичный код при моделировании реальных объектов.</span><span class="sxs-lookup"><span data-stu-id="d3789-106">You can combine object-oriented class design with a data-oriented implementation to provide concise code while modeling real-world objects.</span></span>

<span data-ttu-id="d3789-107">Из этого руководства вы узнаете, как выполнять следующие задачи:</span><span class="sxs-lookup"><span data-stu-id="d3789-107">In this tutorial, you'll learn how to:</span></span>

> [!div class="checklist"]
>
> - <span data-ttu-id="d3789-108">Выражать объектно-ориентированные классы с помощью шаблонов данных.</span><span class="sxs-lookup"><span data-stu-id="d3789-108">Express your object oriented classes using data patterns.</span></span>
> - <span data-ttu-id="d3789-109">Внедрять эти шаблоны, используя функции сопоставления шаблонов на C#.</span><span class="sxs-lookup"><span data-stu-id="d3789-109">Implement those patterns using C#'s pattern matching features.</span></span>
> - <span data-ttu-id="d3789-110">Использовать диагностику компилятора для проверки реализации.</span><span class="sxs-lookup"><span data-stu-id="d3789-110">Leverage compiler diagnostics to validate your implementation.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="d3789-111">Предварительные требования</span><span class="sxs-lookup"><span data-stu-id="d3789-111">Prerequisites</span></span>

<span data-ttu-id="d3789-112">Вам нужно настроить свой компьютер для выполнения .NET 5, включая компилятор C# 9.0.</span><span class="sxs-lookup"><span data-stu-id="d3789-112">You’ll need to set up your machine to run .NET 5, including the C# 9.0 compiler.</span></span> <span data-ttu-id="d3789-113">Компилятор C# 9.0 доступен в [Visual Studio 2019 версии 16.8 (предварительная версия)](https://visualstudio.microsoft.com/vs/preview/) или в [пакете SDK .NET 5.0 (предварительная версия)](https://dotnet.microsoft.com/download/dotnet/5.0).</span><span class="sxs-lookup"><span data-stu-id="d3789-113">The C# 9.0 compiler is available starting with [Visual Studio 2019 version 16.8 preview](https://visualstudio.microsoft.com/vs/preview/) or the [.NET 5.0 SDK preview](https://dotnet.microsoft.com/download/dotnet/5.0).</span></span>

## <a name="build-a-simulation-of-a-canal-lock"></a><span data-ttu-id="d3789-114">Создание симуляции шлюза канала</span><span class="sxs-lookup"><span data-stu-id="d3789-114">Build a simulation of a canal lock</span></span>

<span data-ttu-id="d3789-115">В этом руководстве вы создадите класс C#, который симулирует [шлюз канала](https://en.wikipedia.org/wiki/Lock_(water_navigation)).</span><span class="sxs-lookup"><span data-stu-id="d3789-115">In this tutorial, you'll build a C# class that simulates a [canal lock](https://en.wikipedia.org/wiki/Lock_(water_navigation)).</span></span> <span data-ttu-id="d3789-116">Шлюз — это устройство, которое поднимает и опускает судна, которые перемещаются между двумя водными пространствами на разных уровнях.</span><span class="sxs-lookup"><span data-stu-id="d3789-116">Briefly, a canal lock is a device that raises and lowers boats as they travel between two stretches of water at different levels.</span></span> <span data-ttu-id="d3789-117">Шлюз включает двое ворот и механизм для изменения уровня воды.</span><span class="sxs-lookup"><span data-stu-id="d3789-117">A lock has two gates and some mechanism to change the water level.</span></span>

<span data-ttu-id="d3789-118">При эксплуатации в обычных условиях судно входит в одни из ворот, при этом уровень воды в шлюзе соответствует уровню воды на стороне входа судна.</span><span class="sxs-lookup"><span data-stu-id="d3789-118">In its normal operation, a boat enters one of the gates while the water level in the lock matches the water level on the side the boat enters.</span></span> <span data-ttu-id="d3789-119">Когда судно находится в шлюзовой камере, уровень воды изменяется, чтобы соответствовать уровню воды камеры, из которой судно будет выходить.</span><span class="sxs-lookup"><span data-stu-id="d3789-119">Once in the lock, the water level is changed to match the water level where the boat will leave the lock.</span></span> <span data-ttu-id="d3789-120">Как только уровень воды соответствует уровню воды камеры выхода, в камере выхода открываются ворота.</span><span class="sxs-lookup"><span data-stu-id="d3789-120">Once the water level matches that side, the gate on the exit side opens.</span></span> <span data-ttu-id="d3789-121">Меры безопасности настроены таким образом, чтобы оператор не мог создать опасную ситуацию в шлюзе.</span><span class="sxs-lookup"><span data-stu-id="d3789-121">Safety measures make sure an operator can't create a dangerous situation in the canal.</span></span> <span data-ttu-id="d3789-122">Уровень воды изменяется только при закрытых воротах.</span><span class="sxs-lookup"><span data-stu-id="d3789-122">The water level can be changed only when both gates are closed.</span></span> <span data-ttu-id="d3789-123">Можно открыть только одни ворота.</span><span class="sxs-lookup"><span data-stu-id="d3789-123">At most one gate can be open.</span></span> <span data-ttu-id="d3789-124">Чтобы открыть ворота, внутренний уровень воды в шлюзе должен соответствовать уровню воды на выходе.</span><span class="sxs-lookup"><span data-stu-id="d3789-124">To open a gate, the water level in the lock must match the water level outside the gate being opened.</span></span>

<span data-ttu-id="d3789-125">Для моделирования такого поведения можно создать класс C#.</span><span class="sxs-lookup"><span data-stu-id="d3789-125">You can build a C# class to model this behavior.</span></span> <span data-ttu-id="d3789-126">Класс `CanalLock` будет поддерживать команды для открытия или закрытия обоих ворот.</span><span class="sxs-lookup"><span data-stu-id="d3789-126">A `CanalLock` class would support commands to open or close either gate.</span></span> <span data-ttu-id="d3789-127">А также иметь разные команды для увеличения или уменьшения уровня воды.</span><span class="sxs-lookup"><span data-stu-id="d3789-127">It would have other commands to raise or lower the water.</span></span> <span data-ttu-id="d3789-128">Класс также должен поддерживать свойства для чтения текущего состояния ворот и уровня воды.</span><span class="sxs-lookup"><span data-stu-id="d3789-128">The class should also support properties to read the current state of both gates and the water level.</span></span> <span data-ttu-id="d3789-129">Ваши методы будут реализовать меры безопасности.</span><span class="sxs-lookup"><span data-stu-id="d3789-129">Your methods implement the safety measures.</span></span>

## <a name="define-a-class"></a><span data-ttu-id="d3789-130">Определение класса</span><span class="sxs-lookup"><span data-stu-id="d3789-130">Define a class</span></span>

<span data-ttu-id="d3789-131">Вам нужно будет создать консольное приложение для тестирования класса `CanalLock`.</span><span class="sxs-lookup"><span data-stu-id="d3789-131">You'll build a console application to test your `CanalLock` class.</span></span> <span data-ttu-id="d3789-132">Создайте новый консольный проект для .NET 5 с помощью Visual Studio или интерфейса командной строки .NET.</span><span class="sxs-lookup"><span data-stu-id="d3789-132">Create a new console project for .NET 5 using either Visual Studio or the .NET CLI.</span></span> <span data-ttu-id="d3789-133">Затем добавьте новый класс и назовите его `CanalLock`.</span><span class="sxs-lookup"><span data-stu-id="d3789-133">Then, add a new class and name it `CanalLock`.</span></span> <span data-ttu-id="d3789-134">Теперь создайте общедоступный API, однако не реализуйте методы:</span><span class="sxs-lookup"><span data-stu-id="d3789-134">Next, design your public API, but leave the methods not implemented:</span></span>

:::code language="csharp" source="snippets/pattern-objects/InterimSteps.cs" ID="APIDesign":::

<span data-ttu-id="d3789-135">Приведенный выше код инициализирует объект таким образом, чтобы и те и другие ворота были закрыты, а уровень воды оставался низким.</span><span class="sxs-lookup"><span data-stu-id="d3789-135">The preceding code initializes the object so both gates are closed, and the water level is low.</span></span> <span data-ttu-id="d3789-136">Далее напишите следующий код проверки в методе `Main`, который поможет вам создать первую реализацию класса:</span><span class="sxs-lookup"><span data-stu-id="d3789-136">Next, write the following test code in your `Main` method to guide you as you create a first implementation of the class:</span></span>

:::code language="csharp" source="snippets/pattern-objects/Program.cs" ID="HappyTests":::

<span data-ttu-id="d3789-137">Затем добавьте первую реализацию каждого метода в класс `CanalLock`.</span><span class="sxs-lookup"><span data-stu-id="d3789-137">Next, add a first implementation of each method in the `CanalLock` class.</span></span> <span data-ttu-id="d3789-138">Следующий код реализует методы класса, не влияя на правила безопасности.</span><span class="sxs-lookup"><span data-stu-id="d3789-138">The following code implements the methods of the class without concern to the safety rules.</span></span> <span data-ttu-id="d3789-139">Испытания на безопасность будут добавлены позже:</span><span class="sxs-lookup"><span data-stu-id="d3789-139">You'll add safety tests later:</span></span>

:::code language="csharp" source="snippets/pattern-objects/InterimSteps.cs" ID="FirstImplementation":::

<span data-ttu-id="d3789-140">Тесты, которые вы написали, прошли успешно.</span><span class="sxs-lookup"><span data-stu-id="d3789-140">The tests you've written so far pass.</span></span> <span data-ttu-id="d3789-141">Вы реализовали основы.</span><span class="sxs-lookup"><span data-stu-id="d3789-141">You've implemented the basics.</span></span> <span data-ttu-id="d3789-142">Теперь напишите тест для условия независимого отказа.</span><span class="sxs-lookup"><span data-stu-id="d3789-142">Now, write a test for the first failure condition.</span></span> <span data-ttu-id="d3789-143">По окончании предыдущих тестов одни и другие ворота закрыты, а уровень воды — низкий.</span><span class="sxs-lookup"><span data-stu-id="d3789-143">At the end of the previous tests, both gates are closed, and the water level is set to low.</span></span> <span data-ttu-id="d3789-144">Добавьте тест для открытия верхних ворот:</span><span class="sxs-lookup"><span data-stu-id="d3789-144">Add a test to try opening the upper gate:</span></span>

:::code language="csharp" source="snippets/pattern-objects/Program.cs" ID="HighGateSafetyTest":::

<span data-ttu-id="d3789-145">Тест завершается сбоем, поскольку ворота открываются.</span><span class="sxs-lookup"><span data-stu-id="d3789-145">This test fails because the gate opens.</span></span> <span data-ttu-id="d3789-146">Для первой реализации внесите исправления, используя следующий код:</span><span class="sxs-lookup"><span data-stu-id="d3789-146">As a first implementation, you could fix it with the following code:</span></span>

:::code language="csharp" source="snippets/pattern-objects/InterimSteps.cs" ID="SecondImplementation":::

<span data-ttu-id="d3789-147">Тесты успешно пройдены.</span><span class="sxs-lookup"><span data-stu-id="d3789-147">Your tests pass.</span></span> <span data-ttu-id="d3789-148">При добавлении дополнительных тестов вы добавляете дополнительные `if` предложений и проверяете различные свойства.</span><span class="sxs-lookup"><span data-stu-id="d3789-148">But, as you add more tests, you'll add more and more `if` clauses and test different properties.</span></span> <span data-ttu-id="d3789-149">При добавлении дополнительных условий со временем методы становятся слишком сложными.</span><span class="sxs-lookup"><span data-stu-id="d3789-149">Soon, these methods will get too complicated as you add more conditionals.</span></span>

## <a name="implement-the-commands-with-patterns"></a><span data-ttu-id="d3789-150">Реализация команд с помощью шаблонов</span><span class="sxs-lookup"><span data-stu-id="d3789-150">Implement the commands with patterns</span></span>

<span data-ttu-id="d3789-151">Лучшим решением станет использование *шаблонов*, чтобы определить, находится ли объект в допустимом состоянии для выполнения команды.</span><span class="sxs-lookup"><span data-stu-id="d3789-151">A better way is to use *patterns* to determine if the object is in a valid state to execute a command.</span></span> <span data-ttu-id="d3789-152">Вы можете выразить разрешение на выполнение команды в качестве функции с тремя переменными: состояние ворот, уровень воды и новый параметр.</span><span class="sxs-lookup"><span data-stu-id="d3789-152">You can express if a command is allowed as a function of three variables: the state of the gate, the level of the water, and the new setting:</span></span>

| <span data-ttu-id="d3789-153">Новый параметр</span><span class="sxs-lookup"><span data-stu-id="d3789-153">New setting</span></span> | <span data-ttu-id="d3789-154">Состояние ворот</span><span class="sxs-lookup"><span data-stu-id="d3789-154">Gate state</span></span> | <span data-ttu-id="d3789-155">Уровень воды</span><span class="sxs-lookup"><span data-stu-id="d3789-155">Water Level</span></span> | <span data-ttu-id="d3789-156">Результат</span><span class="sxs-lookup"><span data-stu-id="d3789-156">Result</span></span>             |
| ----------- | ---------- | ----------- | ------------------ |
| <span data-ttu-id="d3789-157">Закрыто</span><span class="sxs-lookup"><span data-stu-id="d3789-157">Closed</span></span>      | <span data-ttu-id="d3789-158">Закрыто</span><span class="sxs-lookup"><span data-stu-id="d3789-158">Closed</span></span>     | <span data-ttu-id="d3789-159">Высокий</span><span class="sxs-lookup"><span data-stu-id="d3789-159">High</span></span>        | <span data-ttu-id="d3789-160">Закрыто</span><span class="sxs-lookup"><span data-stu-id="d3789-160">Closed</span></span>             |
| <span data-ttu-id="d3789-161">Закрыто</span><span class="sxs-lookup"><span data-stu-id="d3789-161">Closed</span></span>      | <span data-ttu-id="d3789-162">Закрыто</span><span class="sxs-lookup"><span data-stu-id="d3789-162">Closed</span></span>     | <span data-ttu-id="d3789-163">Низкий</span><span class="sxs-lookup"><span data-stu-id="d3789-163">Low</span></span>         | <span data-ttu-id="d3789-164">Закрыто</span><span class="sxs-lookup"><span data-stu-id="d3789-164">Closed</span></span>             |
| <span data-ttu-id="d3789-165">Закрыто</span><span class="sxs-lookup"><span data-stu-id="d3789-165">Closed</span></span>      | <span data-ttu-id="d3789-166">Открыть</span><span class="sxs-lookup"><span data-stu-id="d3789-166">Open</span></span>       | <span data-ttu-id="d3789-167">Высокий</span><span class="sxs-lookup"><span data-stu-id="d3789-167">High</span></span>        | <span data-ttu-id="d3789-168">Открыть</span><span class="sxs-lookup"><span data-stu-id="d3789-168">Open</span></span>               |
| <span data-ttu-id="d3789-169">~~Закрыто~~</span><span class="sxs-lookup"><span data-stu-id="d3789-169">~~Closed~~</span></span>  | <span data-ttu-id="d3789-170">~~Открыть~~</span><span class="sxs-lookup"><span data-stu-id="d3789-170">~~Open~~</span></span>   | <span data-ttu-id="d3789-171">~~Низкая~~</span><span class="sxs-lookup"><span data-stu-id="d3789-171">~~Low~~</span></span>     | <span data-ttu-id="d3789-172">~~Закрыто~~</span><span class="sxs-lookup"><span data-stu-id="d3789-172">~~Closed~~</span></span>         |
| <span data-ttu-id="d3789-173">Открыть</span><span class="sxs-lookup"><span data-stu-id="d3789-173">Open</span></span>        | <span data-ttu-id="d3789-174">Закрыто</span><span class="sxs-lookup"><span data-stu-id="d3789-174">Closed</span></span>     | <span data-ttu-id="d3789-175">Высокий</span><span class="sxs-lookup"><span data-stu-id="d3789-175">High</span></span>        | <span data-ttu-id="d3789-176">Открыть</span><span class="sxs-lookup"><span data-stu-id="d3789-176">Open</span></span>               |
| <span data-ttu-id="d3789-177">Открыть</span><span class="sxs-lookup"><span data-stu-id="d3789-177">Open</span></span>        | <span data-ttu-id="d3789-178">Закрыто</span><span class="sxs-lookup"><span data-stu-id="d3789-178">Closed</span></span>     | <span data-ttu-id="d3789-179">Низкий</span><span class="sxs-lookup"><span data-stu-id="d3789-179">Low</span></span>         | <span data-ttu-id="d3789-180">Закрыто (ошибка)</span><span class="sxs-lookup"><span data-stu-id="d3789-180">Closed (Error)</span></span>     |
| <span data-ttu-id="d3789-181">Открыть</span><span class="sxs-lookup"><span data-stu-id="d3789-181">Open</span></span>        | <span data-ttu-id="d3789-182">Открыть</span><span class="sxs-lookup"><span data-stu-id="d3789-182">Open</span></span>       | <span data-ttu-id="d3789-183">Высокий</span><span class="sxs-lookup"><span data-stu-id="d3789-183">High</span></span>        | <span data-ttu-id="d3789-184">Открыть</span><span class="sxs-lookup"><span data-stu-id="d3789-184">Open</span></span>               |
| <span data-ttu-id="d3789-185">~~Открыть~~</span><span class="sxs-lookup"><span data-stu-id="d3789-185">~~Open~~</span></span>    | <span data-ttu-id="d3789-186">~~Открыть~~</span><span class="sxs-lookup"><span data-stu-id="d3789-186">~~Open~~</span></span>   | <span data-ttu-id="d3789-187">~~Низкая~~</span><span class="sxs-lookup"><span data-stu-id="d3789-187">~~Low~~</span></span>     | <span data-ttu-id="d3789-188">~~Закрыто (ошибка)~~</span><span class="sxs-lookup"><span data-stu-id="d3789-188">~~Closed (Error)~~</span></span> |

<span data-ttu-id="d3789-189">Текст четвертой и последней строки в таблице зачеркнут, поскольку они недопустимы.</span><span class="sxs-lookup"><span data-stu-id="d3789-189">The fourth and last rows in the table have strike through text because they're invalid.</span></span> <span data-ttu-id="d3789-190">Добавленный код должен гарантировать, что верхние ворота никогда не откроются при низком уровне воды.</span><span class="sxs-lookup"><span data-stu-id="d3789-190">The code you're adding now should make sure the high water gate is never opened when the water is low.</span></span>  <span data-ttu-id="d3789-191">Эти состояния можно запрограммировать как одиночное выражение switch (помните, что `false` означает "Закрыто"):</span><span class="sxs-lookup"><span data-stu-id="d3789-191">Those states can be coded as a single switch expression (remember that `false` indicates "Closed"):</span></span>

:::code language="csharp" source="snippets/pattern-objects/InterimSteps.cs" ID="ThirdImplementation":::

<span data-ttu-id="d3789-192">Попробуйте эту версию.</span><span class="sxs-lookup"><span data-stu-id="d3789-192">Try this version.</span></span> <span data-ttu-id="d3789-193">Тесты пройдены, проверка кода.</span><span class="sxs-lookup"><span data-stu-id="d3789-193">Your tests pass, validating the code.</span></span> <span data-ttu-id="d3789-194">В полной таблице показаны возможные комбинации входных и выходных значений.</span><span class="sxs-lookup"><span data-stu-id="d3789-194">The full table shows the possible combinations of inputs and results.</span></span> <span data-ttu-id="d3789-195">Это означает, что вы и другие разработчики можете взглянуть на таблицу и проверить охват всех возможных входных данных.</span><span class="sxs-lookup"><span data-stu-id="d3789-195">That means you and other developers can quickly look at the table and see that you've covered all the possible inputs.</span></span> <span data-ttu-id="d3789-196">И даже проще — вам в этом может помочь компилятор.</span><span class="sxs-lookup"><span data-stu-id="d3789-196">Even easier, the compiler can help as well.</span></span> <span data-ttu-id="d3789-197">После добавления предыдущего кода можно увидеть, что компилятор выдает предупреждение: *CS8524* указывает, что выражение switch не охватывает все возможные входные данные.</span><span class="sxs-lookup"><span data-stu-id="d3789-197">After you add the previous code, you can see that the compiler generates a warning: *CS8524* indicates the switch expression doesn't cover all possible inputs.</span></span> <span data-ttu-id="d3789-198">Причиной предупреждения является то, что некоторые входные данные имеют тип `enum`.</span><span class="sxs-lookup"><span data-stu-id="d3789-198">The reason for that warning is that one of the inputs is an `enum` type.</span></span> <span data-ttu-id="d3789-199">Компилятор интерпретирует "все возможные входные данные" как все входные данные из базового типа, обычно это — `int`.</span><span class="sxs-lookup"><span data-stu-id="d3789-199">The compiler interprets "all possible inputs" as all inputs from the underlying type, typically an `int`.</span></span> <span data-ttu-id="d3789-200">Это выражение `switch` проверяет только значения, указанные в `enum`.</span><span class="sxs-lookup"><span data-stu-id="d3789-200">This `switch` expression only checks the values declared in the `enum`.</span></span> <span data-ttu-id="d3789-201">Для устранения предупреждения можно добавить шаблон пустой переменной catch-all для последней ветви выражения.</span><span class="sxs-lookup"><span data-stu-id="d3789-201">To remove the warning, you can add a catch-all discard pattern for the last arm of the expression.</span></span> <span data-ttu-id="d3789-202">Это условие создает исключение, поскольку указывает на недопустимые входные данные:</span><span class="sxs-lookup"><span data-stu-id="d3789-202">This condition throws an exception, because it indicates invalid input:</span></span>

```csharp
_  => throw new InvalidOperationException("Invalid internal state"),
```

<span data-ttu-id="d3789-203">Предыдущая ветвь switch должна быть последней в выражении `switch`, так как она соответствует всем входным данным.</span><span class="sxs-lookup"><span data-stu-id="d3789-203">The preceding switch arm must be last in your `switch` expression because it matches all inputs.</span></span> <span data-ttu-id="d3789-204">Поэкспериментируйте, изменяя порядок.</span><span class="sxs-lookup"><span data-stu-id="d3789-204">Experiment by moving it earlier in the order.</span></span> <span data-ttu-id="d3789-205">Это вызывает ошибку компилятора *CS8510* — недопустимый код в шаблоне.</span><span class="sxs-lookup"><span data-stu-id="d3789-205">That causes a compiler error *CS8510* for unreachable code in a pattern.</span></span>  <span data-ttu-id="d3789-206">Естественная структура выражений switch позволяет компилятору создавать ошибки и предупреждения для потенциальных ошибок.</span><span class="sxs-lookup"><span data-stu-id="d3789-206">The natural structure of switch expressions enables the compiler to generate errors and warnings for possible mistakes.</span></span> <span data-ttu-id="d3789-207">Компилятор "безопасная сеть" упрощает создание чистого кода с меньшим количеством итераций, а также позволяет объединять ветви переключения с подстановочными знаками.</span><span class="sxs-lookup"><span data-stu-id="d3789-207">The compiler "safety net" makes it easier for you to create correct code in fewer iterations, and the freedom to combine switch arms with wildcards.</span></span> <span data-ttu-id="d3789-208">Компилятор выдаст ошибки, если комбинация приведет к недопустимым ветвям, а также к предупреждениям при удалении необходимой ветви.</span><span class="sxs-lookup"><span data-stu-id="d3789-208">The compiler will issue errors if your combination results in unreachable arms you didn't expect, and warnings if you remove an arm that's needed.</span></span>

<span data-ttu-id="d3789-209">Первое изменение состоит в том, чтобы объединить все ветви, в которых командой является закрытие ворот; оно всегда разрешено.</span><span class="sxs-lookup"><span data-stu-id="d3789-209">The first change is to combine all the arms where the command is to close the gate; that's always allowed.</span></span> <span data-ttu-id="d3789-210">Добавьте следующий код в виде первой ветви в выражении switch.</span><span class="sxs-lookup"><span data-stu-id="d3789-210">Add the following code as the first arm in your switch expression:</span></span>

```csharp
(false, _, _) => false,
```

<span data-ttu-id="d3789-211">После добавления предыдущей ветви вы получите четыре ошибки компилятора, по одной на каждую из ветвей в команде `false`.</span><span class="sxs-lookup"><span data-stu-id="d3789-211">After you add the previous switch arm, you'll get four compiler errors, one on each of the arms where the command is `false`.</span></span> <span data-ttu-id="d3789-212">Эти ветви уже охвачены недавно добавленной ветвью.</span><span class="sxs-lookup"><span data-stu-id="d3789-212">Those arms are already covered by the newly added arm.</span></span> <span data-ttu-id="d3789-213">И вы можете безопасно удалить эти четыре строки.</span><span class="sxs-lookup"><span data-stu-id="d3789-213">You can safely remove those four lines.</span></span> <span data-ttu-id="d3789-214">Вы пытались заменить эти условия новой ветвью переключения.</span><span class="sxs-lookup"><span data-stu-id="d3789-214">You intended this new switch arm to replace those conditions.</span></span>

<span data-ttu-id="d3789-215">Теперь можно упростить четыре ветви для команды открытия ворот.</span><span class="sxs-lookup"><span data-stu-id="d3789-215">Next, you can simplify the four arms where the command is to open the gate.</span></span> <span data-ttu-id="d3789-216">Ворота можно открыть в обоих случаях, если уровень воды высок.</span><span class="sxs-lookup"><span data-stu-id="d3789-216">In both cases where the water level is high, the gate can be opened.</span></span> <span data-ttu-id="d3789-217">(В первом случае они уже открыты.) Для первого случая, при котором уровень воды низкий, должно появиться исключение, а для другого — нет.</span><span class="sxs-lookup"><span data-stu-id="d3789-217">(In one, it's already open.) One case where the water level is low throws an exception, and the other shouldn't happen.</span></span> <span data-ttu-id="d3789-218">Если шлюз уже находится в недопустимом состоянии, для появления такого же исключения необходимы безопасные условия.</span><span class="sxs-lookup"><span data-stu-id="d3789-218">It should be safe to throw the same exception if the water lock is already in an invalid state.</span></span> <span data-ttu-id="d3789-219">Эти ветви можно упростить таким образом:</span><span class="sxs-lookup"><span data-stu-id="d3789-219">You can make the following simplifications for those arms:</span></span>

```csharp
(true, _, WaterLevel.High) => true,
(true, false, WaterLevel.Low) => throw new InvalidOperationException("Cannot open high gate when the water is low"),
_ => throw new InvalidOperationException("Invalid internal state"),
```

<span data-ttu-id="d3789-220">Запустите тесты еще раз, они должны пройти успешно.</span><span class="sxs-lookup"><span data-stu-id="d3789-220">Run your tests again, and they pass.</span></span> <span data-ttu-id="d3789-221">Финальная версия метода `SetHighGate` выглядит вот так:</span><span class="sxs-lookup"><span data-stu-id="d3789-221">Here's the final version of the `SetHighGate` method:</span></span>

:::code language="csharp" source="snippets/pattern-objects/CanalLock.cs" ID="FinalImplementaton":::

## <a name="implement-patterns-yourself"></a><span data-ttu-id="d3789-222">Самостоятельное внедрение шаблонов</span><span class="sxs-lookup"><span data-stu-id="d3789-222">Implement patterns yourself</span></span>

<span data-ttu-id="d3789-223">Теперь, когда вы знакомы с методикой, заполните методы `SetLowGate` и `SetWaterLevel` самостоятельно.</span><span class="sxs-lookup"><span data-stu-id="d3789-223">Now that you've seen the technique, fill in the `SetLowGate` and `SetWaterLevel` methods yourself.</span></span>  <span data-ttu-id="d3789-224">Начните с добавления следующего кода для проверки недопустимых операций для этих методов:</span><span class="sxs-lookup"><span data-stu-id="d3789-224">Start by adding the following code to test invalid operations on those methods:</span></span>

:::code language="csharp" source="snippets/pattern-objects/Program.cs" ID="FinalTestCode":::

<span data-ttu-id="d3789-225">Запустите приложение еще раз.</span><span class="sxs-lookup"><span data-stu-id="d3789-225">Run your application again.</span></span> <span data-ttu-id="d3789-226">Видно, что новые тесты завершаются ошибкой, а шлюз переходит в недопустимое состояние.</span><span class="sxs-lookup"><span data-stu-id="d3789-226">You can see the new tests fail, and the canal lock gets into an invalid state.</span></span> <span data-ttu-id="d3789-227">Попробуйте реализовать оставшиеся методы самостоятельно.</span><span class="sxs-lookup"><span data-stu-id="d3789-227">Try to implement the remaining methods yourself.</span></span> <span data-ttu-id="d3789-228">Метод для нижних ворот должен быть идентичен методу для верхних ворот.</span><span class="sxs-lookup"><span data-stu-id="d3789-228">The method to set the lower gate should be similar to the method to set the upper gate.</span></span> <span data-ttu-id="d3789-229">Метод для изменения уровня воды имеет другие проверки, однако должен иметь ту же структуру.</span><span class="sxs-lookup"><span data-stu-id="d3789-229">The method that changes the water level has different checks, but should follow a similar structure.</span></span> <span data-ttu-id="d3789-230">Вы можете использовать тот же процесс для метода, который задает уровень воды.</span><span class="sxs-lookup"><span data-stu-id="d3789-230">You may find it helpful to use the same process for the method that sets the water level.</span></span> <span data-ttu-id="d3789-231">Начните со всех четырех входных данных: состояние обоих ворот, текущий уровень воды и необходимый новый уровень воды.</span><span class="sxs-lookup"><span data-stu-id="d3789-231">Start with all four inputs: The state of both gates, the current state of the water level, and the requested new water level.</span></span> <span data-ttu-id="d3789-232">Выражение switch должно начинаться с:</span><span class="sxs-lookup"><span data-stu-id="d3789-232">The switch expression should start with:</span></span>

```csharp
CanalLockWaterLevel = (newLevel, CanalLockWaterLevel, LowWaterGateOpen, HighWaterGateOpen) switch
{
    // elided
};
```

<span data-ttu-id="d3789-233">Вы получите 16 ветвей переключения, которые нужно заполнить данными.</span><span class="sxs-lookup"><span data-stu-id="d3789-233">You'll have 16 total switch arms to fill in.</span></span> <span data-ttu-id="d3789-234">Проверьте и упростите их.</span><span class="sxs-lookup"><span data-stu-id="d3789-234">Then, test and simplify.</span></span>

<span data-ttu-id="d3789-235">Получилось ли у вас что-то наподобие этого?</span><span class="sxs-lookup"><span data-stu-id="d3789-235">Did you make methods something like this?</span></span>

:::code language="csharp" source="snippets/pattern-objects/CanalLock.cs" ID="FinalExercise":::

<span data-ttu-id="d3789-236">Тесты должны успешно завершиться, а шлюз — работать безопасно.</span><span class="sxs-lookup"><span data-stu-id="d3789-236">Your tests should pass, and the canal lock should operate safely.</span></span>

## <a name="summary"></a><span data-ttu-id="d3789-237">Итоги</span><span class="sxs-lookup"><span data-stu-id="d3789-237">Summary</span></span>

<span data-ttu-id="d3789-238">Из этого руководства вы узнали, как использовать сопоставление шаблонов для проверки внутреннего состояния объекта, прежде чем изменять состояние.</span><span class="sxs-lookup"><span data-stu-id="d3789-238">In this tutorial, you learned to use pattern matching to check the internal state of an object before applying any changes to that state.</span></span> <span data-ttu-id="d3789-239">Вы можете проверять сочетания свойств.</span><span class="sxs-lookup"><span data-stu-id="d3789-239">You can check combinations of properties.</span></span> <span data-ttu-id="d3789-240">После создания таблиц для любого из этих переходов необходимо протестировать код, а затем упростить его для более удобного чтения и сопровождения.</span><span class="sxs-lookup"><span data-stu-id="d3789-240">Once you've built tables for any of those transitions, you test your code, then simplify for readability and maintainability.</span></span> <span data-ttu-id="d3789-241">Эти изначальные рефакторинги могут рекомендовать другие рефакторинги, которые проверяют внутреннее состояние или управляют другими изменениями API.</span><span class="sxs-lookup"><span data-stu-id="d3789-241">These initial refactorings may suggest further refactorings that validate internal state or manage other API changes.</span></span> <span data-ttu-id="d3789-242">В этом учебнике были объединены классы и объекты с более ориентированным на данные подходом, в котором для реализации этих классов используются шаблоны.</span><span class="sxs-lookup"><span data-stu-id="d3789-242">This tutorial combined classes and objects with a more data-oriented, pattern-based approach to implement those classes.</span></span>
