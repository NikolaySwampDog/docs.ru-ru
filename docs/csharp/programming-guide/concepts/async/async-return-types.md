---
title: Типы возвращаемых значений асинхронных операций (C#)
description: Узнайте о типах возвращаемых значений, которые могут быть у асинхронных методов в C#. Рассмотрите примеры кода для каждого типа и ознакомьтесь с дополнительными ресурсами.
ms.date: 08/19/2020
ms.assetid: ddb2539c-c898-48c1-ad92-245e4a996df8
ms.openlocfilehash: 53eb3bedebb99cd829101eee4c2e190c0fb952bf
ms.sourcegitcommit: 1dbe25ff484a02025d5c34146e517c236f7161fb
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "104653456"
---
# <a name="async-return-types-c"></a>Типы возвращаемых значений асинхронных операций (C#)

Асинхронные методы могут иметь следующие типы возвращаемых значений:

- <xref:System.Threading.Tasks.Task> для асинхронного метода, который выполняет операцию, но не возвращает значение.
- <xref:System.Threading.Tasks.Task%601> для асинхронного метода, возвращающего значение.
- `void` для обработчика событий.
- Начиная с версии 7.0 в языке C# поддерживаются любые типы с доступным методом `GetAwaiter`. Объект, возвращаемый методом `GetAwaiter`, должен реализовывать интерфейс <xref:System.Runtime.CompilerServices.ICriticalNotifyCompletion?displayProperty=nameWithType>.
- Начиная с версии 8.0, в языке C# поддерживается интерфейс <xref:System.Collections.Generic.IAsyncEnumerable%601> для асинхронного метода, который возвращает *асинхронный поток*.

Дополнительные сведения об асинхронных методах см. в разделе [Асинхронное программирование с использованием ключевых слов async и await (C#)](./index.md).

Существуют также некоторые другие типы, характерные для рабочих нагрузок Windows.

- <xref:System.Windows.Threading.DispatcherOperation> для асинхронных операций, ограниченных Windows.
- <xref:Windows.Foundation.IAsyncAction> для асинхронных действий в UWP, которые не возвращают значение.
- <xref:Windows.Foundation.IAsyncActionWithProgress%601> для асинхронных действий в UWP, которые сообщают о ходе выполнения, но не возвращают значение.
- <xref:Windows.Foundation.IAsyncOperation%601> для асинхронных операций в UWP, возвращающих значение.
- <xref:Windows.Foundation.IAsyncOperationWithProgress%602> для асинхронных операций в UWP, которые сообщают о ходе выполнения и возвращают значение.

## <a name="task-return-type"></a>Тип возвращаемого значения Task

Асинхронные методы, не содержащие инструкцию `return` или содержащие инструкцию `return`, которая не возвращает операнд, обычно имеют тип возвращаемого значения <xref:System.Threading.Tasks.Task>. При синхронном выполнении такие методы возвращают `void`. Если для асинхронного метода вы используете тип возвращаемого значения <xref:System.Threading.Tasks.Task>, вызывающий метод может использовать оператор `await` для приостановки выполнения вызывающего объекта до завершения вызванного асинхронного метода.

В следующем примере метод `WaitAndApologizeAsync` не содержит инструкцию `return`, в связи с чем он возвращает объект <xref:System.Threading.Tasks.Task>. Возврат `Task` позволяет реализовать ожидание `WaitAndApologizeAsync`. Тип <xref:System.Threading.Tasks.Task> не имеет возвращаемого значения и, соответственно, не содержит свойство `Result`.

:::code language="csharp" source="snippets/async-return-types/async-returns2.cs" id="TaskReturn":::

`WaitAndApologizeAsync` вызывается и ожидается с помощью инструкции await (вместо выражения await), похожей на инструкцию вызова для синхронного метода, возвращающего значение void. Применение оператора await в этом случае не возвращает значение. Если правый операнд `await` имеет значение <xref:System.Threading.Tasks.Task%601>, `await` выражение возвращает результат для `T`. Если же правый операнд `await` имеет значение <xref:System.Threading.Tasks.Task>, `await` и его операнд являются оператором.

Можно отделить вызов `WaitAndApologizeAsync` от применения инструкции await, как показывает следующий код. Однако следует помнить, что `Task` не содержит свойство `Result`, и при применении оператора await к `Task` никакое значение не создается.

В следующем коде вызов метода `WaitAndApologizeAsync` отделяется от ожидания задачи, которую возвращает этот метод.

:::code language="csharp" source="snippets/async-return-types/async-returns2a.cs" id="AwaitTask":::

## <a name="tasktresult-return-type"></a>Тип возвращаемого значения Task\<TResult\>

Тип возвращаемого значения <xref:System.Threading.Tasks.Task%601> используется для асинхронного метода, содержащего инструкцию [return](../../../language-reference/keywords/return.md) с операндом типа `TResult`.

В следующем примере метод `GetLeisureHoursAsync` содержит инструкцию `return`, которая возвращает целое число. Поэтому в объявлении метода должен указываться тип возвращаемого значения `Task<int>`. Асинхронный метод <xref:System.Threading.Tasks.Task.FromResult%2A> представляет собой заполнитель для операции, которая возвращает <xref:System.DateTime.DayOfWeek>.

:::code language="csharp" source="snippets/async-return-types/async-returns1.cs" id="LeisureHours":::

При вызове `GetLeisureHoursAsync` из выражения await в методе `ShowTodaysInfo` это выражение await извлекает целочисленное значение (значение `leisureHours`), хранящееся в задаче, которая возвращается методом `GetLeisureHours`. Дополнительные сведения о выражениях await см. в разделе [await](../../../language-reference/operators/await.md).

Чтобы лучше понять, как `await` получает результат из `Task<T>`, отделите вызов метода `GetLeisureHoursAsync` от применения `await`, как показано в следующем коде. Вызов метода `GetLeisureHoursAsync`, который не ожидается немедленно, возвращает `Task<int>`, как и следовало ожидать из объявления метода. В данном примере эта задача назначается переменной `getLeisureHoursTask`. Поскольку `getLeisureHoursTask` является <xref:System.Threading.Tasks.Task%601>, она содержит свойство <xref:System.Threading.Tasks.Task%601.Result> типа `TResult`. В этом примере `TResult` представляет собой целочисленный тип. Если выражение `await` применяется к `getLeisureHoursTask`, выражение await вычисляется как содержимое свойства <xref:System.Threading.Tasks.Task%601.Result%2A> объекта `getLeisureHoursTask`. Это значение присваивается переменной `ret`.

> [!IMPORTANT]
> Свойство <xref:System.Threading.Tasks.Task%601.Result%2A> является блокирующим свойством. При попытке доступа к нему до завершения его задачи поток, который в текущий момент активен, блокируется до того момента, пока задача не будет завершена, а ее значение не станет доступным. В большинстве случаев следует получать доступ к этому значению с помощью `await` вместо прямого обращения к свойству.
>
> В предыдущем примере извлекалось значение свойства <xref:System.Threading.Tasks.Task%601.Result%2A> для блокировки основного потока. Это позволяет методу `Main` вывести `message` в окно консоли до того, как завершится работа приложения.

:::code language="csharp" source="snippets/async-return-types/async-returns1a.cs" id="StoreTask":::

## <a name="void-return-type"></a>Тип возвращаемого значения Void

Тип возвращаемого значения `void` используется в асинхронных обработчиках событий, для которых требуется тип возвращаемого значения `void`. Поскольку методы, не являющиеся обработчиками событий, не возвращают значения, вместо этого необходимо вернуть <xref:System.Threading.Tasks.Task>. Это вызвано тем, что для асинхронных методов, возвращающих значение `void`, ожидание невозможно. Любой вызывающий объект такого метода должен иметь возможность завершить свою работу, не дожидаясь завершения вызванного асинхронного метода. Вызывающий объект не должен зависеть ни от каких значений и исключений, создаваемых асинхронным методом.

Вызывающий объект асинхронного метода, возвращающего void, не может перехватывать исключения, создаваемые методом, и такие необработанные исключения могут привести к сбою приложения. Если метод, возвращающий <xref:System.Threading.Tasks.Task> или <xref:System.Threading.Tasks.Task%601>, создает исключение, оно хранится в возвращенной задаче. Исключение повторно вызывается при ожидании задачи. Поэтому убедитесь, что любой асинхронный метод, который может вызвать исключение, имеет тип возвращаемого значения <xref:System.Threading.Tasks.Task> или <xref:System.Threading.Tasks.Task%601> и что вызовы метода являются ожидаемыми.

Дополнительные сведения о перехвате исключений в асинхронных методах см. в разделе [Исключения в асинхронных методах](../../../language-reference/keywords/try-catch.md#exceptions-in-async-methods) в статье о [try-catch](../../../language-reference/keywords/try-catch.md).

В следующем примере показано поведение асинхронного обработчика событий. В примере кода асинхронный обработчик событий должен сообщить основному потоку о завершении своей работы. Основной поток может ожидать завершения работы асинхронного обработчика событий перед выходом из программы.

:::code language="csharp" source="snippets/async-return-types/async-returns3.cs":::

## <a name="generalized-async-return-types-and-valuetasktresult"></a>Обобщенные асинхронные типы возвращаемых значений и ValueTask\<TResult\>

Начиная с C# 7.0, асинхронные методы могут возвращать любой тип с доступным методом `GetAwaiter`, который возвращает экземпляр *типа awaiter*. Также тип, возвращаемый методом `GetAwaiter`, должен иметь атрибут <xref:System.Runtime.CompilerServices.AsyncMethodBuilderAttribute?displayProperty=nameWithType>. Дополнительные сведения см. в спецификации функций для [типов возвращаемых значений, подобных задачам](../../../../../_csharplang/proposals/csharp-7.0/task-types.md).

Эта функция является дополнением к [выражениям с поддержкой await](../../../../../_csharplang/spec/expressions.md#awaitable-expressions) с описанием требований для операнда `await`. Обобщенные асинхронные типы возвращаемых значений позволяют компилятору создавать методы `async`, возвращающие различные типы. Благодаря использованию обобщенных асинхронных типов возвращаемых значений производительность в библиотеках .NET повысилась. Поскольку <xref:System.Threading.Tasks.Task> и <xref:System.Threading.Tasks.Task%601> являются ссылочными типами, выделение памяти во влияющих на производительность сегментах (особенно при выделении памяти в ограниченных циклах) может серьезно снизить производительность. Поддержка обобщенных типов возвращаемых значений позволяет возвращать небольшой тип значения вместо ссылочного типа, благодаря чему удается предотвратить избыточное выделение памяти.

На платформе .NET представлена структура <xref:System.Threading.Tasks.ValueTask%601?displayProperty=nameWithType>, которая является упрощенной реализацией обобщенного значения, возвращающего задачу. Чтобы использовать тип <xref:System.Threading.Tasks.ValueTask%601?displayProperty=nameWithType>, необходимо добавить в проект пакет NuGet `System.Threading.Tasks.Extensions`. В следующем примере структура <xref:System.Threading.Tasks.ValueTask%601> используется для извлечения значений двух игральных костей.

:::code language="csharp" source="snippets/async-return-types/async-valuetask.cs":::

Создание обобщенного асинхронного типа возвращаемого значения — сложный сценарий, который используется только в некоторых средах. Вместо этого можно применять типы `Task`, `Task<T>` и `ValueTask<T>`, которые используются в большинстве сценариев для асинхронного кода.

## <a name="async-streams-with-iasyncenumerablet"></a>Асинхронные потоки с IAsyncEnumerable\<T\>

Начиная с C# 8.0, асинхронный метод может возвращать *асинхронный поток*, представленный интерфейсом <xref:System.Collections.Generic.IAsyncEnumerable%601>. Асинхронный поток позволяет перечислять элементы, считываемые из потока, при создании блоков элементов с помощью повторяющихся асинхронных вызовов. В следующем примере показан асинхронный метод, создающий асинхронный поток.

:::code language="csharp" source="snippets/async-return-types/AsyncStreams.cs" id="GenerateAsyncStream":::

В предыдущем примере показано асинхронное считывание строк. После считывания каждой строки код перечисляет каждое слово в строке. Вызывающие объекты будут перечислять каждое слово с помощью оператора `await foreach`. Метод ожидает, когда необходимо асинхронно считать следующую строку из исходной строки.

## <a name="see-also"></a>См. также

- <xref:System.Threading.Tasks.Task.FromResult%2A>
- [Обработка асинхронных задач по мере завершения](start-multiple-async-tasks-and-process-them-as-they-complete.md)
- [Асинхронное программирование с использованием ключевых слов Async и Await (C#)](index.md)
- [async](../../../language-reference/keywords/async.md)
- [await](../../../language-reference/operators/await.md)
