---
title: Типы возвращаемых значений асинхронных операций (C#)
description: Узнайте о типах возвращаемых значений, которые могут быть у асинхронных методов в C#. Рассмотрите примеры кода для каждого типа и ознакомьтесь с дополнительными ресурсами.
ms.date: 08/19/2020
ms.assetid: ddb2539c-c898-48c1-ad92-245e4a996df8
ms.openlocfilehash: 53eb3bedebb99cd829101eee4c2e190c0fb952bf
ms.sourcegitcommit: 1dbe25ff484a02025d5c34146e517c236f7161fb
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "104653456"
---
# <a name="async-return-types-c"></a><span data-ttu-id="defc8-103">Типы возвращаемых значений асинхронных операций (C#)</span><span class="sxs-lookup"><span data-stu-id="defc8-103">Async return types (C#)</span></span>

<span data-ttu-id="defc8-104">Асинхронные методы могут иметь следующие типы возвращаемых значений:</span><span class="sxs-lookup"><span data-stu-id="defc8-104">Async methods can have the following return types:</span></span>

- <span data-ttu-id="defc8-105"><xref:System.Threading.Tasks.Task> для асинхронного метода, который выполняет операцию, но не возвращает значение.</span><span class="sxs-lookup"><span data-stu-id="defc8-105"><xref:System.Threading.Tasks.Task>, for an async method that performs an operation but returns no value.</span></span>
- <span data-ttu-id="defc8-106"><xref:System.Threading.Tasks.Task%601> для асинхронного метода, возвращающего значение.</span><span class="sxs-lookup"><span data-stu-id="defc8-106"><xref:System.Threading.Tasks.Task%601>, for an async method that returns a value.</span></span>
- <span data-ttu-id="defc8-107">`void` для обработчика событий.</span><span class="sxs-lookup"><span data-stu-id="defc8-107">`void`, for an event handler.</span></span>
- <span data-ttu-id="defc8-108">Начиная с версии 7.0 в языке C# поддерживаются любые типы с доступным методом `GetAwaiter`.</span><span class="sxs-lookup"><span data-stu-id="defc8-108">Starting with C# 7.0, any type that has an accessible `GetAwaiter` method.</span></span> <span data-ttu-id="defc8-109">Объект, возвращаемый методом `GetAwaiter`, должен реализовывать интерфейс <xref:System.Runtime.CompilerServices.ICriticalNotifyCompletion?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="defc8-109">The object returned by the `GetAwaiter` method must implement the <xref:System.Runtime.CompilerServices.ICriticalNotifyCompletion?displayProperty=nameWithType> interface.</span></span>
- <span data-ttu-id="defc8-110">Начиная с версии 8.0, в языке C# поддерживается интерфейс <xref:System.Collections.Generic.IAsyncEnumerable%601> для асинхронного метода, который возвращает *асинхронный поток*.</span><span class="sxs-lookup"><span data-stu-id="defc8-110">Starting with C# 8.0, <xref:System.Collections.Generic.IAsyncEnumerable%601>, for an async method that returns an *async stream*.</span></span>

<span data-ttu-id="defc8-111">Дополнительные сведения об асинхронных методах см. в разделе [Асинхронное программирование с использованием ключевых слов async и await (C#)](./index.md).</span><span class="sxs-lookup"><span data-stu-id="defc8-111">For more information about async methods, see [Asynchronous programming with async and await (C#)](./index.md).</span></span>

<span data-ttu-id="defc8-112">Существуют также некоторые другие типы, характерные для рабочих нагрузок Windows.</span><span class="sxs-lookup"><span data-stu-id="defc8-112">Several other types also exist that are specific to Windows workloads:</span></span>

- <span data-ttu-id="defc8-113"><xref:System.Windows.Threading.DispatcherOperation> для асинхронных операций, ограниченных Windows.</span><span class="sxs-lookup"><span data-stu-id="defc8-113"><xref:System.Windows.Threading.DispatcherOperation>, for async operations limited to Windows.</span></span>
- <span data-ttu-id="defc8-114"><xref:Windows.Foundation.IAsyncAction> для асинхронных действий в UWP, которые не возвращают значение.</span><span class="sxs-lookup"><span data-stu-id="defc8-114"><xref:Windows.Foundation.IAsyncAction>, for async actions in UWP that do not return a value.</span></span>
- <span data-ttu-id="defc8-115"><xref:Windows.Foundation.IAsyncActionWithProgress%601> для асинхронных действий в UWP, которые сообщают о ходе выполнения, но не возвращают значение.</span><span class="sxs-lookup"><span data-stu-id="defc8-115"><xref:Windows.Foundation.IAsyncActionWithProgress%601>, for async actions in UWP that report progress but do not return a value.</span></span>
- <span data-ttu-id="defc8-116"><xref:Windows.Foundation.IAsyncOperation%601> для асинхронных операций в UWP, возвращающих значение.</span><span class="sxs-lookup"><span data-stu-id="defc8-116"><xref:Windows.Foundation.IAsyncOperation%601>, for async operations in UWP that return a value.</span></span>
- <span data-ttu-id="defc8-117"><xref:Windows.Foundation.IAsyncOperationWithProgress%602> для асинхронных операций в UWP, которые сообщают о ходе выполнения и возвращают значение.</span><span class="sxs-lookup"><span data-stu-id="defc8-117"><xref:Windows.Foundation.IAsyncOperationWithProgress%602>, for async operations in UWP that report progress and return a value.</span></span>

## <a name="task-return-type"></a><span data-ttu-id="defc8-118">Тип возвращаемого значения Task</span><span class="sxs-lookup"><span data-stu-id="defc8-118">Task return type</span></span>

<span data-ttu-id="defc8-119">Асинхронные методы, не содержащие инструкцию `return` или содержащие инструкцию `return`, которая не возвращает операнд, обычно имеют тип возвращаемого значения <xref:System.Threading.Tasks.Task>.</span><span class="sxs-lookup"><span data-stu-id="defc8-119">Async methods that don't contain a `return` statement or that contain a `return` statement that doesn't return an operand usually have a return type of <xref:System.Threading.Tasks.Task>.</span></span> <span data-ttu-id="defc8-120">При синхронном выполнении такие методы возвращают `void`.</span><span class="sxs-lookup"><span data-stu-id="defc8-120">Such methods return `void` if they run synchronously.</span></span> <span data-ttu-id="defc8-121">Если для асинхронного метода вы используете тип возвращаемого значения <xref:System.Threading.Tasks.Task>, вызывающий метод может использовать оператор `await` для приостановки выполнения вызывающего объекта до завершения вызванного асинхронного метода.</span><span class="sxs-lookup"><span data-stu-id="defc8-121">If you use a <xref:System.Threading.Tasks.Task> return type for an async method, a calling method can use an `await` operator to suspend the caller's completion until the called async method has finished.</span></span>

<span data-ttu-id="defc8-122">В следующем примере метод `WaitAndApologizeAsync` не содержит инструкцию `return`, в связи с чем он возвращает объект <xref:System.Threading.Tasks.Task>.</span><span class="sxs-lookup"><span data-stu-id="defc8-122">In the following example, the `WaitAndApologizeAsync` method doesn't contain a `return` statement, so the method returns a <xref:System.Threading.Tasks.Task> object.</span></span> <span data-ttu-id="defc8-123">Возврат `Task` позволяет реализовать ожидание `WaitAndApologizeAsync`.</span><span class="sxs-lookup"><span data-stu-id="defc8-123">Returning a `Task` enables `WaitAndApologizeAsync` to be awaited.</span></span> <span data-ttu-id="defc8-124">Тип <xref:System.Threading.Tasks.Task> не имеет возвращаемого значения и, соответственно, не содержит свойство `Result`.</span><span class="sxs-lookup"><span data-stu-id="defc8-124">The <xref:System.Threading.Tasks.Task> type doesn't include a `Result` property because it has no return value.</span></span>

:::code language="csharp" source="snippets/async-return-types/async-returns2.cs" id="TaskReturn":::

<span data-ttu-id="defc8-125">`WaitAndApologizeAsync` вызывается и ожидается с помощью инструкции await (вместо выражения await), похожей на инструкцию вызова для синхронного метода, возвращающего значение void.</span><span class="sxs-lookup"><span data-stu-id="defc8-125">`WaitAndApologizeAsync` is awaited by using an await statement instead of an await expression, similar to the calling statement for a synchronous void-returning method.</span></span> <span data-ttu-id="defc8-126">Применение оператора await в этом случае не возвращает значение.</span><span class="sxs-lookup"><span data-stu-id="defc8-126">The application of an await operator in this case doesn't produce a value.</span></span> <span data-ttu-id="defc8-127">Если правый операнд `await` имеет значение <xref:System.Threading.Tasks.Task%601>, `await` выражение возвращает результат для `T`.</span><span class="sxs-lookup"><span data-stu-id="defc8-127">When the right operand of an `await` is a <xref:System.Threading.Tasks.Task%601>, the `await` expression produces a result of `T`.</span></span> <span data-ttu-id="defc8-128">Если же правый операнд `await` имеет значение <xref:System.Threading.Tasks.Task>, `await` и его операнд являются оператором.</span><span class="sxs-lookup"><span data-stu-id="defc8-128">When the right operand of an `await` is a <xref:System.Threading.Tasks.Task>, the `await` and its operand are a statement.</span></span>

<span data-ttu-id="defc8-129">Можно отделить вызов `WaitAndApologizeAsync` от применения инструкции await, как показывает следующий код.</span><span class="sxs-lookup"><span data-stu-id="defc8-129">You can separate the call to `WaitAndApologizeAsync` from the application of an await operator, as the following code shows.</span></span> <span data-ttu-id="defc8-130">Однако следует помнить, что `Task` не содержит свойство `Result`, и при применении оператора await к `Task` никакое значение не создается.</span><span class="sxs-lookup"><span data-stu-id="defc8-130">However, remember that a `Task` doesn't have a `Result` property, and that no value is produced when an await operator is applied to a `Task`.</span></span>

<span data-ttu-id="defc8-131">В следующем коде вызов метода `WaitAndApologizeAsync` отделяется от ожидания задачи, которую возвращает этот метод.</span><span class="sxs-lookup"><span data-stu-id="defc8-131">The following code separates calling the `WaitAndApologizeAsync` method from awaiting the task that the method returns.</span></span>

:::code language="csharp" source="snippets/async-return-types/async-returns2a.cs" id="AwaitTask":::

## <a name="tasktresult-return-type"></a><span data-ttu-id="defc8-132">Тип возвращаемого значения Task\<TResult\></span><span class="sxs-lookup"><span data-stu-id="defc8-132">Task\<TResult\> return type</span></span>

<span data-ttu-id="defc8-133">Тип возвращаемого значения <xref:System.Threading.Tasks.Task%601> используется для асинхронного метода, содержащего инструкцию [return](../../../language-reference/keywords/return.md) с операндом типа `TResult`.</span><span class="sxs-lookup"><span data-stu-id="defc8-133">The <xref:System.Threading.Tasks.Task%601> return type is used for an async method that contains a [return](../../../language-reference/keywords/return.md) statement in which the operand is `TResult`.</span></span>

<span data-ttu-id="defc8-134">В следующем примере метод `GetLeisureHoursAsync` содержит инструкцию `return`, которая возвращает целое число.</span><span class="sxs-lookup"><span data-stu-id="defc8-134">In the following example, the `GetLeisureHoursAsync` method contains a `return` statement that returns an integer.</span></span> <span data-ttu-id="defc8-135">Поэтому в объявлении метода должен указываться тип возвращаемого значения `Task<int>`.</span><span class="sxs-lookup"><span data-stu-id="defc8-135">Therefore, the method declaration must specify a return type of `Task<int>`.</span></span> <span data-ttu-id="defc8-136">Асинхронный метод <xref:System.Threading.Tasks.Task.FromResult%2A> представляет собой заполнитель для операции, которая возвращает <xref:System.DateTime.DayOfWeek>.</span><span class="sxs-lookup"><span data-stu-id="defc8-136">The <xref:System.Threading.Tasks.Task.FromResult%2A> async method is a placeholder for an operation that returns a <xref:System.DateTime.DayOfWeek>.</span></span>

:::code language="csharp" source="snippets/async-return-types/async-returns1.cs" id="LeisureHours":::

<span data-ttu-id="defc8-137">При вызове `GetLeisureHoursAsync` из выражения await в методе `ShowTodaysInfo` это выражение await извлекает целочисленное значение (значение `leisureHours`), хранящееся в задаче, которая возвращается методом `GetLeisureHours`.</span><span class="sxs-lookup"><span data-stu-id="defc8-137">When `GetLeisureHoursAsync` is called from within an await expression in the `ShowTodaysInfo` method, the await expression retrieves the integer value (the value of `leisureHours`) that's stored in the task returned by the `GetLeisureHours` method.</span></span> <span data-ttu-id="defc8-138">Дополнительные сведения о выражениях await см. в разделе [await](../../../language-reference/operators/await.md).</span><span class="sxs-lookup"><span data-stu-id="defc8-138">For more information about await expressions, see [await](../../../language-reference/operators/await.md).</span></span>

<span data-ttu-id="defc8-139">Чтобы лучше понять, как `await` получает результат из `Task<T>`, отделите вызов метода `GetLeisureHoursAsync` от применения `await`, как показано в следующем коде.</span><span class="sxs-lookup"><span data-stu-id="defc8-139">You can better understand how `await` retrieves the result from a `Task<T>` by separating the call to `GetLeisureHoursAsync` from the application of `await`, as the following code shows.</span></span> <span data-ttu-id="defc8-140">Вызов метода `GetLeisureHoursAsync`, который не ожидается немедленно, возвращает `Task<int>`, как и следовало ожидать из объявления метода.</span><span class="sxs-lookup"><span data-stu-id="defc8-140">A call to method `GetLeisureHoursAsync` that isn't immediately awaited returns a `Task<int>`, as you would expect from the declaration of the method.</span></span> <span data-ttu-id="defc8-141">В данном примере эта задача назначается переменной `getLeisureHoursTask`.</span><span class="sxs-lookup"><span data-stu-id="defc8-141">The task is assigned to the `getLeisureHoursTask` variable in the example.</span></span> <span data-ttu-id="defc8-142">Поскольку `getLeisureHoursTask` является <xref:System.Threading.Tasks.Task%601>, она содержит свойство <xref:System.Threading.Tasks.Task%601.Result> типа `TResult`.</span><span class="sxs-lookup"><span data-stu-id="defc8-142">Because `getLeisureHoursTask` is a <xref:System.Threading.Tasks.Task%601>, it contains a <xref:System.Threading.Tasks.Task%601.Result> property of type `TResult`.</span></span> <span data-ttu-id="defc8-143">В этом примере `TResult` представляет собой целочисленный тип.</span><span class="sxs-lookup"><span data-stu-id="defc8-143">In this case, `TResult` represents an integer type.</span></span> <span data-ttu-id="defc8-144">Если выражение `await` применяется к `getLeisureHoursTask`, выражение await вычисляется как содержимое свойства <xref:System.Threading.Tasks.Task%601.Result%2A> объекта `getLeisureHoursTask`.</span><span class="sxs-lookup"><span data-stu-id="defc8-144">When `await` is applied to `getLeisureHoursTask`, the await expression evaluates to the contents of the <xref:System.Threading.Tasks.Task%601.Result%2A> property of `getLeisureHoursTask`.</span></span> <span data-ttu-id="defc8-145">Это значение присваивается переменной `ret`.</span><span class="sxs-lookup"><span data-stu-id="defc8-145">The value is assigned to the `ret` variable.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="defc8-146">Свойство <xref:System.Threading.Tasks.Task%601.Result%2A> является блокирующим свойством.</span><span class="sxs-lookup"><span data-stu-id="defc8-146">The <xref:System.Threading.Tasks.Task%601.Result%2A> property is a blocking property.</span></span> <span data-ttu-id="defc8-147">При попытке доступа к нему до завершения его задачи поток, который в текущий момент активен, блокируется до того момента, пока задача не будет завершена, а ее значение не станет доступным.</span><span class="sxs-lookup"><span data-stu-id="defc8-147">If you try to access it before its task is finished, the thread that's currently active is blocked until the task completes and the value is available.</span></span> <span data-ttu-id="defc8-148">В большинстве случаев следует получать доступ к этому значению с помощью `await` вместо прямого обращения к свойству.</span><span class="sxs-lookup"><span data-stu-id="defc8-148">In most cases, you should access the value by using `await` instead of accessing the property directly.</span></span>
>
> <span data-ttu-id="defc8-149">В предыдущем примере извлекалось значение свойства <xref:System.Threading.Tasks.Task%601.Result%2A> для блокировки основного потока. Это позволяет методу `Main` вывести `message` в окно консоли до того, как завершится работа приложения.</span><span class="sxs-lookup"><span data-stu-id="defc8-149">The previous example retrieved the value of the <xref:System.Threading.Tasks.Task%601.Result%2A> property to block the main thread so that the `Main` method could print the `message` to the console before the application ended.</span></span>

:::code language="csharp" source="snippets/async-return-types/async-returns1a.cs" id="StoreTask":::

## <a name="void-return-type"></a><span data-ttu-id="defc8-150">Тип возвращаемого значения Void</span><span class="sxs-lookup"><span data-stu-id="defc8-150">Void return type</span></span>

<span data-ttu-id="defc8-151">Тип возвращаемого значения `void` используется в асинхронных обработчиках событий, для которых требуется тип возвращаемого значения `void`.</span><span class="sxs-lookup"><span data-stu-id="defc8-151">You use the `void` return type in asynchronous event handlers, which require a `void` return type.</span></span> <span data-ttu-id="defc8-152">Поскольку методы, не являющиеся обработчиками событий, не возвращают значения, вместо этого необходимо вернуть <xref:System.Threading.Tasks.Task>. Это вызвано тем, что для асинхронных методов, возвращающих значение `void`, ожидание невозможно.</span><span class="sxs-lookup"><span data-stu-id="defc8-152">For methods other than event handlers that don't return a value, you should return a <xref:System.Threading.Tasks.Task> instead, because an async method that returns `void` can't be awaited.</span></span> <span data-ttu-id="defc8-153">Любой вызывающий объект такого метода должен иметь возможность завершить свою работу, не дожидаясь завершения вызванного асинхронного метода.</span><span class="sxs-lookup"><span data-stu-id="defc8-153">Any caller of such a method must continue to completion without waiting for the called async method to finish.</span></span> <span data-ttu-id="defc8-154">Вызывающий объект не должен зависеть ни от каких значений и исключений, создаваемых асинхронным методом.</span><span class="sxs-lookup"><span data-stu-id="defc8-154">The caller must be independent of any values or exceptions that the async method generates.</span></span>

<span data-ttu-id="defc8-155">Вызывающий объект асинхронного метода, возвращающего void, не может перехватывать исключения, создаваемые методом, и такие необработанные исключения могут привести к сбою приложения.</span><span class="sxs-lookup"><span data-stu-id="defc8-155">The caller of a void-returning async method can't catch exceptions thrown from the method, and such unhandled exceptions are likely to cause your application to fail.</span></span> <span data-ttu-id="defc8-156">Если метод, возвращающий <xref:System.Threading.Tasks.Task> или <xref:System.Threading.Tasks.Task%601>, создает исключение, оно хранится в возвращенной задаче.</span><span class="sxs-lookup"><span data-stu-id="defc8-156">If a method that returns a <xref:System.Threading.Tasks.Task> or <xref:System.Threading.Tasks.Task%601> throws an exception, the exception is stored in the returned task.</span></span> <span data-ttu-id="defc8-157">Исключение повторно вызывается при ожидании задачи.</span><span class="sxs-lookup"><span data-stu-id="defc8-157">The exception is rethrown when the task is awaited.</span></span> <span data-ttu-id="defc8-158">Поэтому убедитесь, что любой асинхронный метод, который может вызвать исключение, имеет тип возвращаемого значения <xref:System.Threading.Tasks.Task> или <xref:System.Threading.Tasks.Task%601> и что вызовы метода являются ожидаемыми.</span><span class="sxs-lookup"><span data-stu-id="defc8-158">Therefore, make sure that any async method that can produce an exception has a return type of <xref:System.Threading.Tasks.Task> or <xref:System.Threading.Tasks.Task%601> and that calls to the method are awaited.</span></span>

<span data-ttu-id="defc8-159">Дополнительные сведения о перехвате исключений в асинхронных методах см. в разделе [Исключения в асинхронных методах](../../../language-reference/keywords/try-catch.md#exceptions-in-async-methods) в статье о [try-catch](../../../language-reference/keywords/try-catch.md).</span><span class="sxs-lookup"><span data-stu-id="defc8-159">For more information about how to catch exceptions in async methods, see the [Exceptions in async methods](../../../language-reference/keywords/try-catch.md#exceptions-in-async-methods) section of the [try-catch](../../../language-reference/keywords/try-catch.md) article.</span></span>

<span data-ttu-id="defc8-160">В следующем примере показано поведение асинхронного обработчика событий.</span><span class="sxs-lookup"><span data-stu-id="defc8-160">The following example shows the behavior of an async event handler.</span></span> <span data-ttu-id="defc8-161">В примере кода асинхронный обработчик событий должен сообщить основному потоку о завершении своей работы.</span><span class="sxs-lookup"><span data-stu-id="defc8-161">In the example code, an async event handler must let the main thread know when it finishes.</span></span> <span data-ttu-id="defc8-162">Основной поток может ожидать завершения работы асинхронного обработчика событий перед выходом из программы.</span><span class="sxs-lookup"><span data-stu-id="defc8-162">Then the main thread can wait for an async event handler to complete before exiting the program.</span></span>

:::code language="csharp" source="snippets/async-return-types/async-returns3.cs":::

## <a name="generalized-async-return-types-and-valuetasktresult"></a><span data-ttu-id="defc8-163">Обобщенные асинхронные типы возвращаемых значений и ValueTask\<TResult\></span><span class="sxs-lookup"><span data-stu-id="defc8-163">Generalized async return types and ValueTask\<TResult\></span></span>

<span data-ttu-id="defc8-164">Начиная с C# 7.0, асинхронные методы могут возвращать любой тип с доступным методом `GetAwaiter`, который возвращает экземпляр *типа awaiter*.</span><span class="sxs-lookup"><span data-stu-id="defc8-164">Starting with C# 7.0, an async method can return any type that has an accessible `GetAwaiter` method that returns an instance of an *awaiter type*.</span></span> <span data-ttu-id="defc8-165">Также тип, возвращаемый методом `GetAwaiter`, должен иметь атрибут <xref:System.Runtime.CompilerServices.AsyncMethodBuilderAttribute?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="defc8-165">In addition, the type returned from the `GetAwaiter` method must have the <xref:System.Runtime.CompilerServices.AsyncMethodBuilderAttribute?displayProperty=nameWithType> attribute.</span></span> <span data-ttu-id="defc8-166">Дополнительные сведения см. в спецификации функций для [типов возвращаемых значений, подобных задачам](../../../../../_csharplang/proposals/csharp-7.0/task-types.md).</span><span class="sxs-lookup"><span data-stu-id="defc8-166">You can learn more in the feature spec for [Task like return types](../../../../../_csharplang/proposals/csharp-7.0/task-types.md).</span></span>

<span data-ttu-id="defc8-167">Эта функция является дополнением к [выражениям с поддержкой await](../../../../../_csharplang/spec/expressions.md#awaitable-expressions) с описанием требований для операнда `await`.</span><span class="sxs-lookup"><span data-stu-id="defc8-167">This feature is the complement to [awaitable expressions](../../../../../_csharplang/spec/expressions.md#awaitable-expressions), which describes the requirements for the operand of `await`.</span></span> <span data-ttu-id="defc8-168">Обобщенные асинхронные типы возвращаемых значений позволяют компилятору создавать методы `async`, возвращающие различные типы.</span><span class="sxs-lookup"><span data-stu-id="defc8-168">Generalized async return types enable the compiler to generate `async` methods that return different types.</span></span> <span data-ttu-id="defc8-169">Благодаря использованию обобщенных асинхронных типов возвращаемых значений производительность в библиотеках .NET повысилась.</span><span class="sxs-lookup"><span data-stu-id="defc8-169">Generalized async return types enabled performance improvements in the .NET libraries.</span></span> <span data-ttu-id="defc8-170">Поскольку <xref:System.Threading.Tasks.Task> и <xref:System.Threading.Tasks.Task%601> являются ссылочными типами, выделение памяти во влияющих на производительность сегментах (особенно при выделении памяти в ограниченных циклах) может серьезно снизить производительность.</span><span class="sxs-lookup"><span data-stu-id="defc8-170">Because <xref:System.Threading.Tasks.Task> and <xref:System.Threading.Tasks.Task%601> are reference types, memory allocation in performance-critical paths, particularly when allocations occur in tight loops, can adversely affect performance.</span></span> <span data-ttu-id="defc8-171">Поддержка обобщенных типов возвращаемых значений позволяет возвращать небольшой тип значения вместо ссылочного типа, благодаря чему удается предотвратить избыточное выделение памяти.</span><span class="sxs-lookup"><span data-stu-id="defc8-171">Support for generalized return types means that you can return a lightweight value type instead of a reference type to avoid additional memory allocations.</span></span>

<span data-ttu-id="defc8-172">На платформе .NET представлена структура <xref:System.Threading.Tasks.ValueTask%601?displayProperty=nameWithType>, которая является упрощенной реализацией обобщенного значения, возвращающего задачу.</span><span class="sxs-lookup"><span data-stu-id="defc8-172">.NET provides the <xref:System.Threading.Tasks.ValueTask%601?displayProperty=nameWithType> structure as a lightweight implementation of a generalized task-returning value.</span></span> <span data-ttu-id="defc8-173">Чтобы использовать тип <xref:System.Threading.Tasks.ValueTask%601?displayProperty=nameWithType>, необходимо добавить в проект пакет NuGet `System.Threading.Tasks.Extensions`.</span><span class="sxs-lookup"><span data-stu-id="defc8-173">To use the <xref:System.Threading.Tasks.ValueTask%601?displayProperty=nameWithType> type, you must add the `System.Threading.Tasks.Extensions` NuGet package to your project.</span></span> <span data-ttu-id="defc8-174">В следующем примере структура <xref:System.Threading.Tasks.ValueTask%601> используется для извлечения значений двух игральных костей.</span><span class="sxs-lookup"><span data-stu-id="defc8-174">The following example uses the <xref:System.Threading.Tasks.ValueTask%601> structure to retrieve the value of two dice rolls.</span></span>

:::code language="csharp" source="snippets/async-return-types/async-valuetask.cs":::

<span data-ttu-id="defc8-175">Создание обобщенного асинхронного типа возвращаемого значения — сложный сценарий, который используется только в некоторых средах.</span><span class="sxs-lookup"><span data-stu-id="defc8-175">Writing a generalized async return type is an advanced scenario, and is targeted for use in very specific environments.</span></span> <span data-ttu-id="defc8-176">Вместо этого можно применять типы `Task`, `Task<T>` и `ValueTask<T>`, которые используются в большинстве сценариев для асинхронного кода.</span><span class="sxs-lookup"><span data-stu-id="defc8-176">Consider using the `Task`, `Task<T>` and `ValueTask<T>` types instead, which cover most scenarios for asynchronous code.</span></span>

## <a name="async-streams-with-iasyncenumerablet"></a><span data-ttu-id="defc8-177">Асинхронные потоки с IAsyncEnumerable\<T\></span><span class="sxs-lookup"><span data-stu-id="defc8-177">Async streams with IAsyncEnumerable\<T\></span></span>

<span data-ttu-id="defc8-178">Начиная с C# 8.0, асинхронный метод может возвращать *асинхронный поток*, представленный интерфейсом <xref:System.Collections.Generic.IAsyncEnumerable%601>.</span><span class="sxs-lookup"><span data-stu-id="defc8-178">Starting with C# 8.0, an async method may return an *async stream*, represented by <xref:System.Collections.Generic.IAsyncEnumerable%601>.</span></span> <span data-ttu-id="defc8-179">Асинхронный поток позволяет перечислять элементы, считываемые из потока, при создании блоков элементов с помощью повторяющихся асинхронных вызовов.</span><span class="sxs-lookup"><span data-stu-id="defc8-179">An async stream provides a way to enumerate items read from a stream when elements are generated in chunks with repeated asynchronous calls.</span></span> <span data-ttu-id="defc8-180">В следующем примере показан асинхронный метод, создающий асинхронный поток.</span><span class="sxs-lookup"><span data-stu-id="defc8-180">The following example shows an async method that generates an async stream:</span></span>

:::code language="csharp" source="snippets/async-return-types/AsyncStreams.cs" id="GenerateAsyncStream":::

<span data-ttu-id="defc8-181">В предыдущем примере показано асинхронное считывание строк.</span><span class="sxs-lookup"><span data-stu-id="defc8-181">The preceding example reads lines from a string asynchronously.</span></span> <span data-ttu-id="defc8-182">После считывания каждой строки код перечисляет каждое слово в строке.</span><span class="sxs-lookup"><span data-stu-id="defc8-182">Once each line is read, the code enumerates each word in the string.</span></span> <span data-ttu-id="defc8-183">Вызывающие объекты будут перечислять каждое слово с помощью оператора `await foreach`.</span><span class="sxs-lookup"><span data-stu-id="defc8-183">Callers would enumerate each word using the `await foreach` statement.</span></span> <span data-ttu-id="defc8-184">Метод ожидает, когда необходимо асинхронно считать следующую строку из исходной строки.</span><span class="sxs-lookup"><span data-stu-id="defc8-184">The method awaits when it needs to asynchronously read the next line from the source string.</span></span>

## <a name="see-also"></a><span data-ttu-id="defc8-185">См. также</span><span class="sxs-lookup"><span data-stu-id="defc8-185">See also</span></span>

- <xref:System.Threading.Tasks.Task.FromResult%2A>
- [<span data-ttu-id="defc8-186">Обработка асинхронных задач по мере завершения</span><span class="sxs-lookup"><span data-stu-id="defc8-186">Process asynchronous tasks as they complete</span></span>](start-multiple-async-tasks-and-process-them-as-they-complete.md)
- [<span data-ttu-id="defc8-187">Асинхронное программирование с использованием ключевых слов Async и Await (C#)</span><span class="sxs-lookup"><span data-stu-id="defc8-187">Asynchronous programming with async and await (C#)</span></span>](index.md)
- [<span data-ttu-id="defc8-188">async</span><span class="sxs-lookup"><span data-stu-id="defc8-188">async</span></span>](../../../language-reference/keywords/async.md)
- [<span data-ttu-id="defc8-189">await</span><span class="sxs-lookup"><span data-stu-id="defc8-189">await</span></span>](../../../language-reference/operators/await.md)
