---
title: 'CA2007: не следует напрямую ожидать Task (анализ кода)'
description: 'Сведения о правиле анализа кода CA2007: не следует напрямую ожидать Task'
ms.date: 03/08/2019
ms.topic: reference
f1_keywords:
- CA2007
- DoNotDirectlyAwaitATaskAnalyzer
helpviewer_keywords:
- CA2007
author: gewarren
ms.author: gewarren
dev_langs:
- CSharp
ms.openlocfilehash: 9a1e21c75a24357744046ccbf8215fd5364ebfc2
ms.sourcegitcommit: 05d0087dfca85aac9ca2960f86c5efd218bf833f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/30/2021
ms.locfileid: "99754775"
---
# <a name="ca2007-do-not-directly-await-a-task"></a><span data-ttu-id="0042e-103">CA2007. Не следует напрямую ожидать Task</span><span class="sxs-lookup"><span data-stu-id="0042e-103">CA2007: Do not directly await a Task</span></span>

| | <span data-ttu-id="0042e-104">Значение</span><span class="sxs-lookup"><span data-stu-id="0042e-104">Value</span></span> |
|-|-|
| <span data-ttu-id="0042e-105">**Идентификатор правила**</span><span class="sxs-lookup"><span data-stu-id="0042e-105">**Rule ID**</span></span> |<span data-ttu-id="0042e-106">CA2007</span><span class="sxs-lookup"><span data-stu-id="0042e-106">CA2007</span></span>|
| <span data-ttu-id="0042e-107">**Категория**</span><span class="sxs-lookup"><span data-stu-id="0042e-107">**Category**</span></span> |[<span data-ttu-id="0042e-108">Надежность</span><span class="sxs-lookup"><span data-stu-id="0042e-108">Reliability</span></span>](reliability-warnings.md)|
| <span data-ttu-id="0042e-109">**Исправление является критическим или не критическим**</span><span class="sxs-lookup"><span data-stu-id="0042e-109">**Fix is breaking or non-breaking**</span></span> |<span data-ttu-id="0042e-110">Не критическое</span><span class="sxs-lookup"><span data-stu-id="0042e-110">Non-breaking</span></span>|

## <a name="cause"></a><span data-ttu-id="0042e-111">Причина</span><span class="sxs-lookup"><span data-stu-id="0042e-111">Cause</span></span>

<span data-ttu-id="0042e-112">Асинхронный метод [ожидает](../../../csharp/language-reference/operators/await.md) класс <xref:System.Threading.Tasks.Task> напрямую.</span><span class="sxs-lookup"><span data-stu-id="0042e-112">An asynchronous method [awaits](../../../csharp/language-reference/operators/await.md) a <xref:System.Threading.Tasks.Task> directly.</span></span>

## <a name="rule-description"></a><span data-ttu-id="0042e-113">Описание правила</span><span class="sxs-lookup"><span data-stu-id="0042e-113">Rule description</span></span>

<span data-ttu-id="0042e-114">Когда асинхронный метод ожидает класс <xref:System.Threading.Tasks.Task> напрямую, продолжение обычно происходит в том же потоке, который создал задачу, в зависимости от асинхронного контекста.</span><span class="sxs-lookup"><span data-stu-id="0042e-114">When an asynchronous method awaits a <xref:System.Threading.Tasks.Task> directly, continuation usually occurs in the same thread that created the task, depending on the async context.</span></span> <span data-ttu-id="0042e-115">Такое поведение может быть дорогостоящим в плане производительности и может привести к взаимоблокировке потока пользовательского интерфейса.</span><span class="sxs-lookup"><span data-stu-id="0042e-115">This behavior can be costly in terms of performance and can result in a deadlock on the UI thread.</span></span> <span data-ttu-id="0042e-116">Чтобы сообщить о намерении продолжения, рассмотрите возможность вызова метода <xref:System.Threading.Tasks.Task.ConfigureAwait(System.Boolean)?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="0042e-116">Consider calling <xref:System.Threading.Tasks.Task.ConfigureAwait(System.Boolean)?displayProperty=nameWithType> to signal your intention for continuation.</span></span>

## <a name="how-to-fix-violations"></a><span data-ttu-id="0042e-117">Устранение нарушений</span><span class="sxs-lookup"><span data-stu-id="0042e-117">How to fix violations</span></span>

<span data-ttu-id="0042e-118">Чтобы устранить нарушения, вызовите метод <xref:System.Threading.Tasks.Task.ConfigureAwait%2A> для ожидаемого класса <xref:System.Threading.Tasks.Task>.</span><span class="sxs-lookup"><span data-stu-id="0042e-118">To fix violations, call <xref:System.Threading.Tasks.Task.ConfigureAwait%2A> on the awaited <xref:System.Threading.Tasks.Task>.</span></span> <span data-ttu-id="0042e-119">Параметру `continueOnCapturedContext` можно передать значение `true` или `false`.</span><span class="sxs-lookup"><span data-stu-id="0042e-119">You can pass either `true` or `false` for the `continueOnCapturedContext` parameter.</span></span>

- <span data-ttu-id="0042e-120">Поведение вызова `ConfigureAwait(true)` для задачи аналогично поведению неявного вызова <xref:System.Threading.Tasks.Task.ConfigureAwait%2A>.</span><span class="sxs-lookup"><span data-stu-id="0042e-120">Calling `ConfigureAwait(true)` on the task has the same behavior as not explicitly calling <xref:System.Threading.Tasks.Task.ConfigureAwait%2A>.</span></span> <span data-ttu-id="0042e-121">Вызывая этот метод явным образом, вы даете понять читателям, что намеренно хотите продолжать выполнение в исходном контексте синхронизации.</span><span class="sxs-lookup"><span data-stu-id="0042e-121">By explicitly calling this method, you're letting readers know you intentionally want to perform the continuation on the original synchronization context.</span></span>

- <span data-ttu-id="0042e-122">Вызовите `ConfigureAwait(false)` для задачи, чтобы запланировать продолжение в пуле потоков и избежать тем самым взаимоблокировки в потоке пользовательского интерфейса.</span><span class="sxs-lookup"><span data-stu-id="0042e-122">Call `ConfigureAwait(false)` on the task to schedule continuations to the thread pool, thereby avoiding a deadlock on the UI thread.</span></span> <span data-ttu-id="0042e-123">Передачу значения `false` целесообразно использовать для библиотек, независимых от приложений.</span><span class="sxs-lookup"><span data-stu-id="0042e-123">Passing `false` is a good option for app-independent libraries.</span></span>

## <a name="example"></a><span data-ttu-id="0042e-124">Пример</span><span class="sxs-lookup"><span data-stu-id="0042e-124">Example</span></span>

<span data-ttu-id="0042e-125">Следующий фрагмент кода приводит к возникновению предупреждения:</span><span class="sxs-lookup"><span data-stu-id="0042e-125">The following code snippet generates the warning:</span></span>

```csharp
public async Task Execute()
{
    Task task = null;
    await task;
}
```

<span data-ttu-id="0042e-126">Чтобы устранить нарушение, вызовите метод <xref:System.Threading.Tasks.Task.ConfigureAwait%2A> для ожидаемого класса <xref:System.Threading.Tasks.Task>:</span><span class="sxs-lookup"><span data-stu-id="0042e-126">To fix the violation, call <xref:System.Threading.Tasks.Task.ConfigureAwait%2A> on the awaited <xref:System.Threading.Tasks.Task>:</span></span>

```csharp
public async Task Execute()
{
    Task task = null;
    await task.ConfigureAwait(false);
}
```

## <a name="when-to-suppress-warnings"></a><span data-ttu-id="0042e-127">Условия для отключения предупреждений</span><span class="sxs-lookup"><span data-stu-id="0042e-127">When to suppress warnings</span></span>

<span data-ttu-id="0042e-128">Это предупреждение предназначено для библиотек, где код может выполняться в произвольных средах и не должен делать предположений о среде или о том, как вызывающий объект метода может вызываться или ожидать метод.</span><span class="sxs-lookup"><span data-stu-id="0042e-128">This warning is intended for libraries, where the code may be executed in arbitrary environments and where code shouldn't make assumptions about the environment or how the caller of the method may be invoking or waiting on it.</span></span> <span data-ttu-id="0042e-129">Как правило, рекомендуется полностью подавлять вывод предупреждения для проектов, представляющих код приложения, а не код библиотеки. На самом деле запуск анализатора в коде приложения (например, обработчики событий нажатия кнопки в проекте WinForms или WPF), скорее всего, приведет к выполнению неправильных действий.</span><span class="sxs-lookup"><span data-stu-id="0042e-129">It is generally appropriate to suppress the warning entirely for projects that represent application code rather than library code; in fact, running this analyzer on application code (for example, button click event handlers in a WinForms or WPF project) is likely to lead to the wrong actions being taken.</span></span>

<span data-ttu-id="0042e-130">Вывод этого предупреждения можно отключить в любой ситуации, когда продолжение выполнения должно быть запланировано в исходном контексте, или при отсутствии такого контекста.</span><span class="sxs-lookup"><span data-stu-id="0042e-130">You can suppress this warning in any situation where either the continuation should be scheduled back to the original context or where there is no such context in place.</span></span> <span data-ttu-id="0042e-131">Например, при написании кода в обработчике событий нажатия кнопки в приложении WinForms или WPF в общем случае продолжение из ожидания должно выполняться в потоке пользовательского интерфейса, и, таким образом, желательным поведением по умолчанию будет планирование продолжения выполнения обратно в исходном контексте.</span><span class="sxs-lookup"><span data-stu-id="0042e-131">For example, when writing code in a button click event handler in a WinForms or WPF application, in general the continuation from an await should run on the UI thread, and thus the default behavior of scheduling the continuation back to the originating context is desirable.</span></span> <span data-ttu-id="0042e-132">Другой пример: при написании кода в приложении ASP.NET Core по умолчанию отсутствует <xref:System.Threading.SynchronizationContext> или <xref:System.Threading.Tasks.TaskScheduler>, поэтому `ConfigureAwait` не приведет к изменению поведения.</span><span class="sxs-lookup"><span data-stu-id="0042e-132">As another example, when writing code in an ASP.NET Core application, by default there is no <xref:System.Threading.SynchronizationContext> or <xref:System.Threading.Tasks.TaskScheduler>, for which reason a `ConfigureAwait` wouldn't actually change any behavior.</span></span>

[!INCLUDE [suppress-warning](../../../../includes/code-analysis/suppress-warning.md)]

## <a name="configure-code-to-analyze"></a><span data-ttu-id="0042e-133">Настройка кода для анализа</span><span class="sxs-lookup"><span data-stu-id="0042e-133">Configure code to analyze</span></span>

<span data-ttu-id="0042e-134">Используйте следующие параметры, чтобы указать части базы кода, к которым будет применяться это правило.</span><span class="sxs-lookup"><span data-stu-id="0042e-134">Use the following options to configure which parts of your codebase to run this rule on.</span></span>

- [<span data-ttu-id="0042e-135">Исключить асинхронные методы void</span><span class="sxs-lookup"><span data-stu-id="0042e-135">Exclude async void methods</span></span>](#exclude-async-void-methods)
- [<span data-ttu-id="0042e-136">Тип вывода</span><span class="sxs-lookup"><span data-stu-id="0042e-136">Output kind</span></span>](#output-kind)

<span data-ttu-id="0042e-137">Все эти параметры можно настроить только для некоторого правила, для всех правил или для всех правил в этой категории ([надежность](reliability-warnings.md)).</span><span class="sxs-lookup"><span data-stu-id="0042e-137">You can configure all of these options for just this rule, for all rules, or for all rules in this category ([Reliability](reliability-warnings.md)).</span></span> <span data-ttu-id="0042e-138">Дополнительные сведения см. в статье [Параметры конфигурации правила качества кода](../code-quality-rule-options.md).</span><span class="sxs-lookup"><span data-stu-id="0042e-138">For more information, see [Code quality rule configuration options](../code-quality-rule-options.md).</span></span>

### <a name="exclude-async-void-methods"></a><span data-ttu-id="0042e-139">Исключение асинхронных методов void</span><span class="sxs-lookup"><span data-stu-id="0042e-139">Exclude async void methods</span></span>

<span data-ttu-id="0042e-140">Можно настроить, следует ли исключать асинхронные методы, которые не возвращают значение из этого правила.</span><span class="sxs-lookup"><span data-stu-id="0042e-140">You can configure whether you want to exclude asynchronous methods that don't return a value from this rule.</span></span> <span data-ttu-id="0042e-141">Чтобы исключить эти типы методов, добавьте следующую пару "ключ-значение" в файл *.editorconfig* в проекте:</span><span class="sxs-lookup"><span data-stu-id="0042e-141">To exclude these kinds of methods, add the following key-value pair to an *.editorconfig* file in your project:</span></span>

```ini
# Package version 2.9.0 and later
dotnet_code_quality.CA2007.exclude_async_void_methods = true

# Package version 2.6.3 and earlier
dotnet_code_quality.CA2007.skip_async_void_methods = true
```

### <a name="output-kind"></a><span data-ttu-id="0042e-142">Тип вывода</span><span class="sxs-lookup"><span data-stu-id="0042e-142">Output kind</span></span>

<span data-ttu-id="0042e-143">Можно также настроить типы выходных сборок, к которым применяется это правило.</span><span class="sxs-lookup"><span data-stu-id="0042e-143">You can also configure which output assembly kinds to apply this rule to.</span></span> <span data-ttu-id="0042e-144">Например, чтобы применить это правило только к коду, который создает консольное приложение или динамически связанную библиотеку (то есть не приложение пользовательского интерфейса), добавьте следующую пару "ключ-значение" в файл *.editorconfig* в проекте:</span><span class="sxs-lookup"><span data-stu-id="0042e-144">For example, to only apply this rule to code that produces a console application or a dynamically linked library (that is, not a UI app), add the following key-value pair to an *.editorconfig* file in your project:</span></span>

```ini
dotnet_code_quality.CA2007.output_kind = ConsoleApplication, DynamicallyLinkedLibrary
```

## <a name="see-also"></a><span data-ttu-id="0042e-145">См. также раздел</span><span class="sxs-lookup"><span data-stu-id="0042e-145">See also</span></span>

- [<span data-ttu-id="0042e-146">Вопросы и ответы по ConfigureAwait</span><span class="sxs-lookup"><span data-stu-id="0042e-146">ConfigureAwait FAQ</span></span>](https://devblogs.microsoft.com/dotnet/configureawait-faq/)
- [<span data-ttu-id="0042e-147">Следует ли ожидать задачи с ConfigureAwait(false)?</span><span class="sxs-lookup"><span data-stu-id="0042e-147">Should I await a task with ConfigureAwait(false)?</span></span>](https://github.com/Microsoft/vs-threading/blob/master/doc/cookbook_vs.md#should-i-await-a-task-with-configureawaitfalse)
- [<span data-ttu-id="0042e-148">CA2008. Не создавайте задачи без передачи TaskScheduler</span><span class="sxs-lookup"><span data-stu-id="0042e-148">CA2008: Do not create tasks without passing a TaskScheduler</span></span>](ca2008.md)
- [<span data-ttu-id="0042e-149">Правила надежности</span><span class="sxs-lookup"><span data-stu-id="0042e-149">Reliability rules</span></span>](reliability-warnings.md)
