---
title: 'CA3075: обработка небезопасных DTD (анализ кода)'
description: Дополнительные сведения о правиле анализа кода CA3075 — обработка небезопасных DTD
ms.date: 03/18/2019
ms.topic: reference
author: gewarren
ms.author: gewarren
ms.openlocfilehash: 9e48a4e7594b7f04c14510f509b46646786119db
ms.sourcegitcommit: 05d0087dfca85aac9ca2960f86c5efd218bf833f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/30/2021
ms.locfileid: "99787634"
---
# <a name="ca3075-insecure-dtd-processing"></a><span data-ttu-id="5e240-103">CA3075. Обработка небезопасных DTD</span><span class="sxs-lookup"><span data-stu-id="5e240-103">CA3075: Insecure DTD Processing</span></span>

| | <span data-ttu-id="5e240-104">Значение</span><span class="sxs-lookup"><span data-stu-id="5e240-104">Value</span></span> |
|-|-|
| <span data-ttu-id="5e240-105">**Идентификатор правила**</span><span class="sxs-lookup"><span data-stu-id="5e240-105">**Rule ID**</span></span> |<span data-ttu-id="5e240-106">CA3075</span><span class="sxs-lookup"><span data-stu-id="5e240-106">CA3075</span></span>|
| <span data-ttu-id="5e240-107">**Категория**</span><span class="sxs-lookup"><span data-stu-id="5e240-107">**Category**</span></span> |[<span data-ttu-id="5e240-108">Безопасность</span><span class="sxs-lookup"><span data-stu-id="5e240-108">Security</span></span>](security-warnings.md)|
| <span data-ttu-id="5e240-109">**Исправление является критическим или не критическим**</span><span class="sxs-lookup"><span data-stu-id="5e240-109">**Fix is breaking or non-breaking**</span></span> |<span data-ttu-id="5e240-110">Не критическое</span><span class="sxs-lookup"><span data-stu-id="5e240-110">Non-breaking</span></span>|

## <a name="cause"></a><span data-ttu-id="5e240-111">Причина</span><span class="sxs-lookup"><span data-stu-id="5e240-111">Cause</span></span>

<span data-ttu-id="5e240-112">Если вы используете небезопасные экземпляры <xref:System.Xml.XmlReaderSettings.DtdProcessing%2A> или ссылаетесь на источники внешних сущностей, средство синтаксического анализа может принять недоверенные входные данные и раскрыть конфиденциальную информацию злоумышленникам.</span><span class="sxs-lookup"><span data-stu-id="5e240-112">If you use insecure <xref:System.Xml.XmlReaderSettings.DtdProcessing%2A> instances or reference external entity sources, the parser may accept untrusted input and disclose sensitive information to attackers.</span></span>

## <a name="rule-description"></a><span data-ttu-id="5e240-113">Описание правила</span><span class="sxs-lookup"><span data-stu-id="5e240-113">Rule description</span></span>

<span data-ttu-id="5e240-114">*DTD* — это один из двух способов определения допустимости документа средством синтаксического анализа XML, как указано в  [стандарте XML 1.0 консорциума W3C](https://www.w3.org/TR/2008/REC-xml-20081126/).</span><span class="sxs-lookup"><span data-stu-id="5e240-114">A *Document Type Definition (DTD)* is one of two ways an XML parser can determine the validity of a document, as defined by the  [World Wide Web Consortium (W3C) Extensible Markup Language (XML) 1.0](https://www.w3.org/TR/2008/REC-xml-20081126/).</span></span> <span data-ttu-id="5e240-115">Это правило ищет свойства и экземпляры, в которых принимаются недоверенные данные, для предупреждения разработчиков о возможных угрозах [раскрытия информации](../../../framework/wcf/feature-details/information-disclosure.md) или атака типа [отказ в обслуживании (DoS)](../../../framework/wcf/feature-details/denial-of-service.md).</span><span class="sxs-lookup"><span data-stu-id="5e240-115">This rule seeks properties and instances where untrusted data is accepted to warn developers about potential [Information Disclosure](../../../framework/wcf/feature-details/information-disclosure.md) threats or [Denial of Service (DoS)](../../../framework/wcf/feature-details/denial-of-service.md) attacks.</span></span> <span data-ttu-id="5e240-116">Это правило активируется, если:</span><span class="sxs-lookup"><span data-stu-id="5e240-116">This rule triggers when:</span></span>

- <span data-ttu-id="5e240-117">обработка DtdProcessing включена в экземпляре <xref:System.Xml.XmlReader> , который разрешает внешние сущности XML с использованием <xref:System.Xml.XmlUrlResolver>;</span><span class="sxs-lookup"><span data-stu-id="5e240-117">DtdProcessing is enabled on the <xref:System.Xml.XmlReader> instance, which resolves external XML entities using <xref:System.Xml.XmlUrlResolver>.</span></span>

- <span data-ttu-id="5e240-118">задано свойство <xref:System.Xml.XmlNode.InnerXml%2A> в XML;</span><span class="sxs-lookup"><span data-stu-id="5e240-118">The <xref:System.Xml.XmlNode.InnerXml%2A> property in the XML is set.</span></span>

- <span data-ttu-id="5e240-119">для свойства <xref:System.Xml.XmlReaderSettings.DtdProcessing%2A> задано значение Parse;</span><span class="sxs-lookup"><span data-stu-id="5e240-119"><xref:System.Xml.XmlReaderSettings.DtdProcessing%2A> property is set to Parse.</span></span>

- <span data-ttu-id="5e240-120">недоверенные входные данные обрабатываются с помощью <xref:System.Xml.XmlResolver> вместо <xref:System.Xml.XmlSecureResolver>;</span><span class="sxs-lookup"><span data-stu-id="5e240-120">Untrusted input is processed using <xref:System.Xml.XmlResolver> instead of <xref:System.Xml.XmlSecureResolver>.</span></span>

- <span data-ttu-id="5e240-121">метод <xref:System.Xml.XmlReader.Create%2A?displayProperty=nameWithType> вызывается с небезопасным экземпляром <xref:System.Xml.XmlReaderSettings> или без экземпляра;</span><span class="sxs-lookup"><span data-stu-id="5e240-121">The <xref:System.Xml.XmlReader.Create%2A?displayProperty=nameWithType> method is invoked with an insecure <xref:System.Xml.XmlReaderSettings> instance or no instance at all.</span></span>

- <span data-ttu-id="5e240-122"><xref:System.Xml.XmlReader> создается с небезопасными настройками или значениями по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="5e240-122"><xref:System.Xml.XmlReader> is created with insecure default settings or values.</span></span>

<span data-ttu-id="5e240-123">В каждом из этих случаев результат одинаковый: содержимое из файловой системы или сетевых папок с компьютера, на котором обрабатывается XML, станет доступно злоумышленнику, или обработка DTD может использоваться для атак типа "отказ в обслуживании".</span><span class="sxs-lookup"><span data-stu-id="5e240-123">In each of these cases, the outcome is the same: the contents from either the file system or network shares from the machine where the XML is processed will be exposed to the attacker, or DTD processing can be used as a DoS vector.</span></span>

## <a name="how-to-fix-violations"></a><span data-ttu-id="5e240-124">Устранение нарушений</span><span class="sxs-lookup"><span data-stu-id="5e240-124">How to fix violations</span></span>

- <span data-ttu-id="5e240-125">Перехватывайте и обрабатывайте все исключения XmlTextReader соответствующим образом, чтобы не допустить раскрытия информации.</span><span class="sxs-lookup"><span data-stu-id="5e240-125">Catch and process all XmlTextReader exceptions properly to avoid path information disclosure.</span></span>

- <span data-ttu-id="5e240-126">Используйте <xref:System.Xml.XmlSecureResolver>, чтобы ограничить набор ресурсов, к которым может получить доступ XmlTextReader.</span><span class="sxs-lookup"><span data-stu-id="5e240-126">Use the <xref:System.Xml.XmlSecureResolver> to restrict the resources that the XmlTextReader can access.</span></span>

- <span data-ttu-id="5e240-127">Не разрешайте <xref:System.Xml.XmlReader> открывать какие-либо внешние ресурсы, установив для свойства <xref:System.Xml.XmlResolver> значение **NULL**.</span><span class="sxs-lookup"><span data-stu-id="5e240-127">Do not allow the <xref:System.Xml.XmlReader> to open any external resources by setting the <xref:System.Xml.XmlResolver> property to **null**.</span></span>

- <span data-ttu-id="5e240-128">Убедитесь, что свойство <xref:System.Data.DataViewManager.DataViewSettingCollectionString%2A?displayProperty=nameWithType> назначено из доверенного источника.</span><span class="sxs-lookup"><span data-stu-id="5e240-128">Ensure that the <xref:System.Data.DataViewManager.DataViewSettingCollectionString%2A?displayProperty=nameWithType> property is assigned from a trusted source.</span></span>

### <a name="net-framework-35-and-earlier"></a><span data-ttu-id="5e240-129">NET Framework 3.5 и предыдущие версии</span><span class="sxs-lookup"><span data-stu-id="5e240-129">.NET Framework 3.5 and earlier</span></span>

- <span data-ttu-id="5e240-130">Отключите обработку DTD при работе с недоверенными источниками, задав для свойства <xref:System.Xml.XmlReaderSettings.ProhibitDtd%2A> значение **true**.</span><span class="sxs-lookup"><span data-stu-id="5e240-130">Disable DTD processing if you are dealing with untrusted sources by setting the <xref:System.Xml.XmlReaderSettings.ProhibitDtd%2A> property to **true**.</span></span>

- <span data-ttu-id="5e240-131">Класс XmlTextReader содержит полное требование наследования доверия.</span><span class="sxs-lookup"><span data-stu-id="5e240-131">XmlTextReader class has a full trust inheritance demand.</span></span>

### <a name="net-framework-4-and-later"></a><span data-ttu-id="5e240-132">.NET Framework 4 и более поздних версий</span><span class="sxs-lookup"><span data-stu-id="5e240-132">.NET Framework 4 and later</span></span>

- <span data-ttu-id="5e240-133">Не включайте обработку DTD при работе с недоверенными источниками, задав для свойства <xref:System.Xml.XmlReaderSettings.DtdProcessing%2A?displayProperty=nameWithType> значение **Prohibit** или **Ignore**.</span><span class="sxs-lookup"><span data-stu-id="5e240-133">Avoid enabling DtdProcessing if you're dealing with untrusted sources by setting the <xref:System.Xml.XmlReaderSettings.DtdProcessing%2A?displayProperty=nameWithType> property to **Prohibit** or **Ignore**.</span></span>

- <span data-ttu-id="5e240-134">Убедитесь, что метод Load() принимает экземпляр XmlReader во всех случаях InnerXml.</span><span class="sxs-lookup"><span data-stu-id="5e240-134">Ensure that the Load() method takes an XmlReader instance in all InnerXml cases.</span></span>

> [!NOTE]
> <span data-ttu-id="5e240-135">Это правило может ложно срабатывать в некоторых допустимых экземплярах XmlSecureResolver.</span><span class="sxs-lookup"><span data-stu-id="5e240-135">This rule might report false positives on some valid XmlSecureResolver instances.</span></span>

## <a name="when-to-suppress-warnings"></a><span data-ttu-id="5e240-136">Условия для отключения предупреждений</span><span class="sxs-lookup"><span data-stu-id="5e240-136">When to suppress warnings</span></span>

<span data-ttu-id="5e240-137">Отключайте правило этого предупреждения, только если уверены, что входные данные получены из доверенного источника.</span><span class="sxs-lookup"><span data-stu-id="5e240-137">Unless you're sure that the input is known to be from a trusted source, do not suppress a rule from this warning.</span></span>

## <a name="pseudo-code-examples"></a><span data-ttu-id="5e240-138">Примеры псевдокода</span><span class="sxs-lookup"><span data-stu-id="5e240-138">Pseudo-code examples</span></span>

### <a name="violation-1"></a><span data-ttu-id="5e240-139">Нарушение 1</span><span class="sxs-lookup"><span data-stu-id="5e240-139">Violation 1</span></span>

```csharp
using System.IO;
using System.Xml.Schema;

class TestClass
{
    public XmlSchema Test
    {
        get
        {
            var src = "";
            TextReader tr = new StreamReader(src);
            XmlSchema schema = XmlSchema.Read(tr, null); // warn
            return schema;
        }
    }
}
```

### <a name="solution-1"></a><span data-ttu-id="5e240-140">Решение 1</span><span class="sxs-lookup"><span data-stu-id="5e240-140">Solution 1</span></span>

```csharp
using System.IO;
using System.Xml;
using System.Xml.Schema;

class TestClass
{
    public XmlSchema Test
    {
        get
        {
            var src = "";
            TextReader tr = new StreamReader(src);
            XmlReader reader = XmlReader.Create(tr, new XmlReaderSettings() { XmlResolver = null });
            XmlSchema schema = XmlSchema.Read(reader , null);
            return schema;
        }
    }
}
```

### <a name="violation-2"></a><span data-ttu-id="5e240-141">Нарушение 2</span><span class="sxs-lookup"><span data-stu-id="5e240-141">Violation 2</span></span>

```csharp
using System.Xml;

namespace TestNamespace
{
    public class TestClass
    {
        public XmlReaderSettings settings = new XmlReaderSettings();
        public void TestMethod(string path)
        {
            var reader = XmlReader.Create(path, settings);  // warn
        }
    }
}
```

### <a name="solution-2"></a><span data-ttu-id="5e240-142">Решение 2</span><span class="sxs-lookup"><span data-stu-id="5e240-142">Solution 2</span></span>

```csharp
using System.Xml;

namespace TestNamespace
{
    public class TestClass
    {
        public XmlReaderSettings settings = new XmlReaderSettings()
        {
            DtdProcessing = DtdProcessing.Prohibit
        };

        public void TestMethod(string path)
        {
            var reader = XmlReader.Create(path, settings);
        }
    }
}
```

### <a name="violation-3"></a><span data-ttu-id="5e240-143">Нарушение 3</span><span class="sxs-lookup"><span data-stu-id="5e240-143">Violation 3</span></span>

```csharp
using System.Xml;

namespace TestNamespace
{
    public class DoNotUseSetInnerXml
    {
        public void TestMethod(string xml)
        {
            XmlDocument doc = new XmlDocument() { XmlResolver = null };
            doc.InnerXml = xml; // warn
        }
    }
}
```

```csharp
using System.Xml;

namespace TestNamespace
{
    public class DoNotUseLoadXml
    {
        public void TestMethod(string xml)
        {
            XmlDocument doc = new XmlDocument(){ XmlResolver = null };
            doc.LoadXml(xml); // warn
        }
    }
}
```

### <a name="solution-3"></a><span data-ttu-id="5e240-144">Решение 3</span><span class="sxs-lookup"><span data-stu-id="5e240-144">Solution 3</span></span>

```csharp
using System.Xml;

public static void TestMethod(string xml)
{
    XmlDocument doc = new XmlDocument() { XmlResolver = null };
    System.IO.StringReader sreader = new System.IO.StringReader(xml);
    XmlReader reader = XmlReader.Create(sreader, new XmlReaderSettings() { XmlResolver = null });
    doc.Load(reader);
}
```

### <a name="violation-4"></a><span data-ttu-id="5e240-145">Нарушение 4</span><span class="sxs-lookup"><span data-stu-id="5e240-145">Violation 4</span></span>

```csharp
using System.IO;
using System.Xml;
using System.Xml.Serialization;

namespace TestNamespace
{
    public class UseXmlReaderForDeserialize
    {
        public void TestMethod(Stream stream)
        {
            XmlSerializer serializer = new XmlSerializer(typeof(UseXmlReaderForDeserialize));
            serializer.Deserialize(stream); // warn
        }
    }
}
```

### <a name="solution-4"></a><span data-ttu-id="5e240-146">Решение 4</span><span class="sxs-lookup"><span data-stu-id="5e240-146">Solution 4</span></span>

```csharp
using System.IO;
using System.Xml;
using System.Xml.Serialization;

namespace TestNamespace
{
    public class UseXmlReaderForDeserialize
    {
        public void TestMethod(Stream stream)
        {
            XmlSerializer serializer = new XmlSerializer(typeof(UseXmlReaderForDeserialize));
            XmlReader reader = XmlReader.Create(stream, new XmlReaderSettings() { XmlResolver = null });
            serializer.Deserialize(reader );
        }
    }
}
```

### <a name="violation-5"></a><span data-ttu-id="5e240-147">Нарушение 5</span><span class="sxs-lookup"><span data-stu-id="5e240-147">Violation 5</span></span>

```csharp
using System.Xml;
using System.Xml.XPath;

namespace TestNamespace
{
    public class UseXmlReaderForXPathDocument
    {
        public void TestMethod(string path)
        {
            XPathDocument doc = new XPathDocument(path); // warn
        }
    }
}
```

### <a name="solution-5"></a><span data-ttu-id="5e240-148">Решение 5</span><span class="sxs-lookup"><span data-stu-id="5e240-148">Solution 5</span></span>

```csharp
using System.Xml;
using System.Xml.XPath;

namespace TestNamespace
{
    public class UseXmlReaderForXPathDocument
    {
        public void TestMethod(string path)
        {
            XmlReader reader = XmlReader.Create(path, new XmlReaderSettings() { XmlResolver = null });
            XPathDocument doc = new XPathDocument(reader);
        }
    }
}
```

### <a name="violation-6"></a><span data-ttu-id="5e240-149">Нарушение 6</span><span class="sxs-lookup"><span data-stu-id="5e240-149">Violation 6</span></span>

```csharp
using System.Xml;

namespace TestNamespace
{
    class TestClass
    {
        public XmlDocument doc = new XmlDocument() { XmlResolver = new XmlUrlResolver() };
    }
}
```

### <a name="solution-6"></a><span data-ttu-id="5e240-150">Решение 6</span><span class="sxs-lookup"><span data-stu-id="5e240-150">Solution 6</span></span>

```csharp
using System.Xml;

namespace TestNamespace
{
    class TestClass
    {
        public XmlDocument doc = new XmlDocument() { XmlResolver = null }; // or set to a XmlSecureResolver instance
    }
}
```

### <a name="violation-7"></a><span data-ttu-id="5e240-151">Нарушение 7</span><span class="sxs-lookup"><span data-stu-id="5e240-151">Violation 7</span></span>

```csharp
using System.Xml;

namespace TestNamespace
{
    class TestClass
    {
        private static void TestMethod()
        {
            var reader = XmlTextReader.Create(""doc.xml""); //warn
        }
    }
}
```

```csharp
using System.Xml;

namespace TestNamespace
{
    public class TestClass
    {
        public void TestMethod(string path)
        {
            try {
                XmlTextReader reader = new XmlTextReader(path); // warn
            }
            catch { throw ; }
            finally {}
        }
    }
}
```

### <a name="solution-7"></a><span data-ttu-id="5e240-152">Решение 7</span><span class="sxs-lookup"><span data-stu-id="5e240-152">Solution 7</span></span>

```csharp
using System.Xml;

namespace TestNamespace
{
    public class TestClass
    {
        public void TestMethod(string path)
        {
            XmlReaderSettings settings = new XmlReaderSettings() { XmlResolver = null };
            XmlReader reader = XmlReader.Create(path, settings);
        }
    }
}
```

> [!NOTE]
> <span data-ttu-id="5e240-153">Хотя <xref:System.Xml.XmlReader.Create%2A?displayProperty=nameWithType> является рекомендуемым способом создания экземпляра <xref:System.Xml.XmlReader>, поведение отличается от <xref:System.Xml.XmlTextReader>.</span><span class="sxs-lookup"><span data-stu-id="5e240-153">Although <xref:System.Xml.XmlReader.Create%2A?displayProperty=nameWithType> is the recommended way to create an <xref:System.Xml.XmlReader> instance, there are behavior differences from <xref:System.Xml.XmlTextReader>.</span></span> <span data-ttu-id="5e240-154"><xref:System.Xml.XmlReader> из <xref:System.Xml.XmlReader.Create%2A> нормализует `\r\n` до `\n` в значениях XML, при этом <xref:System.Xml.XmlTextReader> сохраняет последовательность `\r\n`.</span><span class="sxs-lookup"><span data-stu-id="5e240-154">An <xref:System.Xml.XmlReader> from <xref:System.Xml.XmlReader.Create%2A> normalizes `\r\n` to `\n` in XML values, while <xref:System.Xml.XmlTextReader> preserves the `\r\n` sequence.</span></span>
