---
title: 'CA1045: не передавайте типы по ссылке (анализ кода)'
description: 'Дополнительные сведения о правиле анализа кода "CA1045: не передавайте типы по ссылке"'
ms.date: 11/04/2016
ms.topic: reference
f1_keywords:
- CA1045
- DoNotPassTypesByReference
helpviewer_keywords:
- CA1045
- DoNotPassTypesByReference
author: gewarren
ms.author: gewarren
ms.openlocfilehash: 1c1ad6a69232f7cfa48bb888733fe464eb00ab1e
ms.sourcegitcommit: 05d0087dfca85aac9ca2960f86c5efd218bf833f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/30/2021
ms.locfileid: "99547054"
---
# <a name="ca1045-do-not-pass-types-by-reference"></a>CA1045. Не передавайте типы по ссылке

| | Значение |
|-|-|
| **Идентификатор правила** |CA1045|
| **Категория** |[Microsoft.Design](design-warnings.md)|
| **Исправление является критическим или не критическим** |Критическое|

## <a name="cause"></a>Причина

Открытый или защищенный метод в открытом типе имеет параметр `ref`, принимающий примитивный тип, ссылочный тип или тип значения, не являющийся одним из встроенных типов.

## <a name="rule-description"></a>Описание правила

Для реализации передачи типов по ссылке (с помощью ключевого слова `out` или `ref`) от разработчика требуется опыт работы с указателями, понимание отличия между типами значения и ссылочными типами и умение работать с методами с несколькими возвращаемыми значениями. Кроме того, далеко не все понимают разницу между параметрами `out` и `ref`.

Когда ссылочный тип передается "по ссылке", метод намеревается использовать этот параметр для возврата другого экземпляра объекта. (Передача ссылочного типа по ссылке также называется использованием двойного указателя, указателем на указатель или двойным косвенным обращением.) При использовании соглашения о вызовах по умолчанию, которое передает "по значению", параметр, который принимает ссылочный тип, уже получает указатель на объект. Указатель, а не объект, на который он указывает, передается по значению. Передача по значению означает, что метод не может изменить указатель, чтобы он указывал на новый экземпляр ссылочного типа, но может изменить содержимое объекта, на который он указывает. Для большинства приложений это достаточно и дает желаемое поведение.

Если метод должен возвращать другой экземпляр, используйте для этого возвращаемое значение метода. См. класс <xref:System.String?displayProperty=fullName> для различных методов, которые работают со строками и возвращают новый экземпляр строки. Использование этой модели позволяет вызывающему объекту решить, сохраняется ли исходный объект.

Хотя возвращаемые значения являются наиболее распространенными и часто используются, правильное применение параметров `out` и `ref` требует среднего уровня навыков проектирования и программирования. Архитекторам, разрабатывающим библиотеки для широкого использования, не следует рассчитывать, что пользователи хорошо разбираются в использовании параметров `out` и `ref`.

> [!NOTE]
> При работе с параметрами, которые являются большими структурами, дополнительные ресурсы, необходимые для копирования этих структур, могут повлиять на производительность при передаче по значению. В таких случаях можно рассмотреть использование параметров `ref` или `out`.

## <a name="how-to-fix-violations"></a>Устранение нарушений

Чтобы устранить нарушение этого правила, вызванное типом значения, метод должен вернуть объект в качестве возвращаемого значения. Если метод должен возвращать несколько значений, перепроектируйте его для возврата одного экземпляра объекта, содержащего значения.

Чтобы устранить нарушение этого правила, вызванное ссылочным типом, убедитесь, что желаемое поведение состоит в возвращении нового экземпляра ссылки. Если это так, метод должен использовать его возвращаемое значение для этого.

## <a name="when-to-suppress-warnings"></a>Условия для отключения предупреждений

Предупреждения о нарушении этого правила можно безопасно скрывать. Однако такая схема может вызвать проблемы с удобством использования.

[!INCLUDE [suppress-warning](../../../../includes/code-analysis/suppress-warning.md)]

## <a name="configure-code-to-analyze"></a>Настройка кода для анализа

Используйте следующий параметр, чтобы выбрать части базы кода для применения этого правила.

- [Включение определенных контактных зон API](#include-specific-api-surfaces)

Этот параметр можно настроить только для некоторого правила, для всех правил или для всех правил в этой категории ([конструктор](design-warnings.md)). Дополнительные сведения см. в статье [Параметры конфигурации правила качества кода](../code-quality-rule-options.md).

[!INCLUDE[api-surface](~/includes/code-analysis/api-surface.md)]

## <a name="example"></a>Пример

В следующей библиотеке показаны две реализации класса, которые создают ответы на отзывы пользователя. Первая реализация (`BadRefAndOut`) заставляет пользователя библиотеки управлять тремя возвращаемыми значениями. Вторая реализация (`RedesignedRefAndOut`) упрощает взаимодействие с пользователем, возвращая экземпляр класса контейнера (`ReplyData`), который управляет данными как единым целым.

:::code language="csharp" source="snippets/csharp/all-rules/ca1045.cs" id="snippet1":::

## <a name="example-1"></a>Пример 1

В следующем приложении показана работа пользователя. Вызов переработанной библиотеки (метода `UseTheSimplifiedClass`) более прост, и сведениями, возвращаемыми методом, легко управлять. Оба метода дают одинаковые результаты.

:::code language="csharp" source="snippets/csharp/all-rules/ca1045.cs" id="snippet2":::

## <a name="example-2"></a>Пример 2

В следующем примере библиотеки показано, как используются параметры `ref` для ссылочных типов, и демонстрируется лучший способ реализации этой функции.

:::code language="csharp" source="snippets/csharp/all-rules/ca1045.cs" id="snippet3":::

## <a name="example-3"></a>Пример 3

Следующее приложение вызывает каждый метод в библиотеке, чтобы продемонстрировать поведение.

:::code language="csharp" source="snippets/csharp/all-rules/ca1045.cs" id="snippet4":::

В этом примере выводятся следующие данные:

```txt
Changing pointer - passed by value:
12345
12345
Changing pointer - passed by reference:
12345
12345 ABCDE
Passing by return value:
12345 ABCDE
```

## <a name="related-rules"></a>Связанные правила

[CA1021. Не используйте параметры out](ca1021.md)
