---
title: Действия в рабочем процессе внешнего цикла DevOps для приложения Docker
description: Сведения об этапах, относящихся к "внешнему циклу" рабочего процесса DevOps
ms.date: 01/06/2021
ms.openlocfilehash: 8bca36d5aa0fef95d684a96a5c6017ec15956358
ms.sourcegitcommit: 5ce37699c2a51ed173171813be68ef7577b1aba5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/23/2021
ms.locfileid: "104881098"
---
# <a name="steps-in-the-outer-loop-devops-workflow-for-a-docker-application"></a>Действия в рабочем процессе внешнего цикла DevOps для приложения Docker

На рис. 5-1 приводится комплексное описание этапов, относящихся к рабочему процессу внешнего цикла DevOps. Здесь представлен "внешний цикл" DevOps. После отправки кода в репозиторий начинает работу конвейер непрерывной интеграции, а затем конвейер непрерывного развертывания, на котором осуществляется развертывание приложения. Собранные метрики развернутых приложений передаются в рабочую нагрузку разработки, где реализуется "внутренний цикл". Таким образом, команда разработчиков получает актуальные данные, на основе которых может реагировать на потребности пользователей и бизнеса.

![Схема, на которой показано шесть шагов внешнего цикла DevOps.](./media/docker-application-outer-loop-devops-workflow/overview-dev-ops-outter-loop-workflow.png)

**Рис. 5-1**. Рабочий процесс внешнего цикла DevOps для приложений Docker с использованием средств Майкрософт

Далее рассмотрим каждый из этих этапов более подробно.

## <a name="step-1-inner-loop-development-workflow"></a>Шаг 1. Рабочий процесс внутреннего цикла разработки

Этот этап подробно описывается в главе 4. Напомним, что внешний цикл начинается именно здесь, в момент, когда разработчик отправляет код в систему управления версиями (например, Git), запуская конвейер непрерывной интеграции.

## <a name="step-2-source-code-control-integration-and-management-with-azure-devops-services-and-git"></a>Шаг 2. Интеграция с системой управления версиями и управление ею с использованием Azure DevOps Services и Git

На этом этапе используется система управления версиями, которая собирает консолидированную версию всего кода на основе отправляемых различными разработчиками команды данных.

Работа с системами управления версиями хорошо знакома практически каждому разработчику. Тем не менее при создании приложений Docker в рамках жизненного цикла DevOps важно помнить, что не нужно отправлять образы Docker вместе с приложением с компьютера разработчика напрямую в глобальный реестр Docker (например, в реестр контейнеров Azure или Docker Hub). Напротив, выпускаемые и развертываемые в рабочих средах образы Docker должны создаваться исключительно на основе исходного кода, который интегрируется с глобальным конвейером сборки или непрерывной интеграции на базе вашего репозитория исходного кода (например, Git).

Создаваемые разработчиками локальные образы должны использоваться ими только для тестирования на собственных компьютерах. Именно поэтому активацию контейнера DevOps важно осуществлять из кода системы управления версиями.

Azure DevOps Services и Team Foundation Server поддерживают Git и систему управления версиями Team Foundation. Выберите подходящую систему, чтобы использовать все преимущества комплексного решения на основе технологий Майкрософт. Тем не менее вы можете использовать для управления кодом сторонние репозитории (например, GitHub, локальные репозитории Git или Subversion) и по-прежнему сможете подключаться к ним и получать код, который будет выступать в качестве отправной точки для конвейера непрерывной интеграции DevOps.

## <a name="step-3-build-ci-integrate-and-test-with-azure-devops-services-and-docker"></a>Шаг 3. Сборка, непрерывная интеграция, интеграция и тестирование с использованием Azure DevOps Services и Docker

Технологии непрерывной интеграции стали общепринятым стандартом для современных процессов тестирования и доставки программного обеспечения. Решение Docker обеспечивает четкое разделение задач между командой разработчиков и операционной командой. Неизменность образов Docker позволяет гарантировать успешное многократное развертывание компонентов, которые разрабатываются, тестируются в рамках процесса непрерывной интеграции и выполняются в рабочей среде. Подсистема Docker развертывается на ноутбуках разработчиков, а инфраструктура тестирования обеспечивает возможность переноса контейнеров между средами.

На этом этапе после отправки правильного кода в систему управления версиями вам необходимо выполнить *построение службы* на основе этого кода и выполнить глобальные процедуры сборки и тестирования.

Внутренний рабочий процесс этого этапа (непрерывная интеграция, сборка, тестирование) включает в себя построение конвейера непрерывной интеграции, состоящего из репозитория кода (Git и т. д.), сервера сборки (Azure DevOps Services), подсистемы Docker и реестра Docker.

Вы можете использовать Azure DevOps Services в качестве основы для построения приложений, организации конвейера непрерывной сборки и публикации "артефактов" сборки в "репозитории артефактов" (см. описание следующего этапа).

При использовании технологии Docker для развертывания в качестве "конечных артефактов" развертываются образы Docker, в которые встроены ваши приложения или службы. Эти образы отправляются или публикуются в *реестр Docker* (закрытый репозиторий, аналогичный присутствующим в реестре контейнеров Azure, или открытый, как реестр Docker Hub, который широко применяется для размещения официальных базовых образов).

Ниже описываются основные принципы этого процесса: Контейнер непрерывной интеграции активируется в момент фиксации кода в репозитории системы управления версиями, например в Git. В результате фиксации службы Azure DevOps Services запускают задание сборки в контейнере Docker и после его успешного выполнения отправляют образ Docker в реестр Docker, как показано на рис. 5-2. Это первая часть внешнего цикла, которая включает в себя этапы с 1 по 3: написание, выполнение, отладка и проверка кода; отправка кода в репозиторий; сборка и тестирование в рамках процесса непрерывной интеграции.

![Схема, на которой показаны три шага рабочего процесса непрерывной интеграции.](./media/docker-application-outer-loop-devops-workflow/continuous-integration-steps.png)

**Рис. 5-2**. Этапы процесса непрерывной интеграции

Далее описываются основные этапы рабочего процесса непрерывной интеграции с использованием Docker и Azure DevOps Services:

1. Разработчик отправляет код для фиксации в репозиторий системы управления версиями (Git, Azure DevOps Services, GitHub и т. д.).

2. Если вы используете Azure DevOps Services или Git, вам будут доступны встроенные технологии непрерывной интеграции, для использования которых достаточно установить соответствующий флажок в Azure DevOps Services. При работе со сторонней системой управления версиями (например, GitHub), `webhook` будет отправлять в Azure DevOps Services уведомления об обновлениях либо передавать их в Git или GitHub.

3. Службы Azure DevOps Services извлекают из репозитория системы управления версиями данные, в том числе файл Dockerfile с описанием образа, а также код приложения и тестов.

4. Службы Azure DevOps Services выполняют построение образа Docker и присваивают ему номер сборки.

5. Службы Azure DevOps создают экземпляр контейнера Docker в подготовленном узле Docker и проводят соответствующие тесты.

6. В случае успешного завершения тестов образу присваивается значащее имя, указывающее на то, что эта сборка утверждена (например, "/1.0.0" или другое соответствующее имя), после чего он отправляется в реестр Docker (Docker Hub, реестр контейнеров Azure, DTR и т. д.).

### <a name="implementing-the-ci-pipeline-with-azure-devops-services-and-the-docker-extension-for-azure-devops-services"></a>Реализация конвейера непрерывной интеграции с использованием Azure DevOps Services и расширения Docker для Azure DevOps Services

В Visual Studio Azure DevOps Services содержатся шаблоны сборки и выпуска, которые можно использовать в конвейере непрерывной интеграции или непрерывного развертывания, используемом для сборки образов Docker, отправки образов Docker в прошедший проверку подлинности реестр Docker, запуска образов Docker или выполнения других операций, предлагаемых интерфейсом командной строки Docker. Также эти службы добавляют задачу Docker Compose, с помощью которой можно выполнять сборку, отправку и запуск многоконтейнерных приложений Docker, а также другие операции, предлагаемые интерфейсом командной строки Docker Compose, как показано на рис. 5-3.

![Снимок экрана: конвейер непрерывной интеграции Docker в Azure DevOps.](./media/docker-application-outer-loop-devops-workflow/docker-ci-pipeline-azure-devops.png)

**Рис. 5-3**. Конвейер непрерывной интеграции Docker в Azure DevOps Services, включающий шаблоны сборки и выпуска, а также связанные с ними задачи.

Эти шаблоны и задачи можно использовать для построения артефактов непрерывной интеграции и непрерывного развертывания для сборки, тестирования и развертывания в Azure Service Fabric, службе Azure Kubernetes и аналогичных предложениях.

Используя эти задачи Visual Studio Team Services, узел или виртуальную машину сборки Linux-Docker, подготовленные в Azure, а также предпочтительный реестр Docker (реестр контейнеров Azure, Docker Hub, закрытый доверенный реестр Docker DTR или любой другой реестр Docker), вы можете обеспечить максимально согласованное построение конвейера непрерывной интеграции Docker.

***Требования:***

- Службы Azure DevOps Services либо (для локальной установки) Team Foundation Server 2015 с обновлением 3 или более поздней версии.

- Агент Azure DevOps Services, содержащий двоичные файлы Docker.

  Простой способ создать один из таких агентов заключается в использовании Docker для запуска контейнера на основе образа Docker агента Azure DevOps Services.

> [!TIP]
> Дополнительные сведения о сборке конвейера непрерывной интеграции Docker для Azure DevOps Services и соответствующие пошаговые руководства см. на следующих веб-сайтах.
>
> - Запуск агента Visual Studio Team Services (теперь Azure DevOps Services) в качестве контейнера Docker: \
>   <https://hub.docker.com/_/microsoft-azure-pipelines-vsts-agent>
>
> - Сборка образов Docker .NET Linux с использованием Azure DevOps Services: \
>   <https://docs.microsoft.com/archive/blogs/stevelasker/building-net-core-linux-docker-images-with-visual-studio-team-services>
>
> - Построение машины сборки Visual Studio Team Service на основе Linux с поддержкой Docker: \
>   <https://www.donovanbrown.com/post/Building-a-Linux-Based-Visual-Studio-Team-Service-Build-Machine-with-Docker-Support>

### <a name="integrate-test-and-validate-multi-container-docker-applications"></a>Интеграция, тестирование и проверка многоконтейнерных приложений Docker

Большинство приложений Docker состоит не из одного, а из нескольких контейнеров. В качестве примера можно привести ориентированные на работу с микрослужбами приложения, в которых обычно используется один контейнер для каждой микрослужбы. Тем не менее, даже если ваше приложение Docker не рассчитано на работу с микрослужбами, в нем скорее всего будет использоваться несколько контейнеров или служб.

Таким образом, после построения контейнеров приложения на конвейере непрерывной интеграции вам также необходимо выполнить развертывание, интеграцию и тестирование приложения в целом со всеми его контейнерами в узле интеграции Docker или даже в кластере тестирования, в котором будут распространяться ваши контейнеры.

Если вам требуется один узел, используйте команды Docker, например docker-compose, для развертывания связанных контейнеров с целью протестировать и проверить среду Docker на отдельной виртуальной машине. Если же вы работаете с кластером оркестратора, таким как DC/OS, Kubernetes или Docker Swarm, для развертывания контейнеров необходимо использовать другой механизм или оркестратор, в зависимости от выбранного кластера или планировщика.

Ниже описывается несколько типов тестов, которые можно выполнять в отношении контейнеров Docker:

- Модульные тесты для контейнеров Docker

- Тестирование групп взаимосвязанных приложений или микрослужб

- Тестирование в рабочей среде и ранних выпусках

Важно помнить, что интеграционные и функциональные тесты следует выполнять за пределами контейнеров. Тесты не включаются в состав развертываемых контейнеров, поскольку контейнеры основываются на статических образах, которые должны в точности соответствовать тем, которые будут развернуты в рабочей среде.

При тестировании в более сложных сценариях, например с участием нескольких кластеров (кластер тестирования, промежуточный и рабочий кластеры), целесообразно публиковать образы в реестре, что позволяет выполнять тестирование в нескольких кластерах.

### <a name="push-the-custom-application-docker-image-into-your-global-docker-registry"></a>Отправка образа пользовательского приложения Docker в глобальный реестр Docker

После тестирования и проверки образов Docker можно присвоить им теги и опубликовать их в реестре Docker. Реестр Docker — это критически важный компонент жизненного цикла приложения Docker, который представляет собой централизованное место для хранения пользовательских тестов (так называемые утвержденные образы), которые будут развертываться в средах для контроля качества и рабочих средах.

Как и репозиторий системы управления версиями (Git и т. д.), в котором хранится проверенный код приложения, реестр Docker является вашим надежным источником для двоичных приложений и компонентов, которые будут развертываться в средах для контроля качества и рабочих средах.

Как правило, пользовательские образы хранятся либо в закрытом репозитории (в реестре контейнеров Azure или в локальном реестре, например в доверенном реестре Docker), либо в открытом облачном реестре с ограниченным доступом (например, Docker Hub). Обратите внимание, что в последнем случае, если вы не работаете с открытым исходным кодом, вы должны доверять системе безопасности поставщика. В любом случае используемый метод будет аналогичен команде `docker push` и построен на ее основе, как показано на рис. 5-4.

![Схема, на которой показана отправка пользовательских образов в реестр контейнеров.](./media/docker-application-outer-loop-devops-workflow/docker-push-custom-images.png)

**Рис. 5-4**. Публикация пользовательских образов в реестре Docker

На этапе 3 при построении интеграции и тестирования (непрерывная интеграция) вы можете публиковать полученные образы Docker в закрытом или общедоступном реестре. На рынке представлены реестры Docker, предлагаемые целым рядом поставщиков облачных решений, в том числе реестр контейнеров Azure, Amazon Web Services Container Registry, Google Container Registry, Quay Registry и другие.

С помощью задач Docker вы можете отправлять набор образов служб с несколькими тегами, определяемый в файле `docker-compose.yml`, в прошедший проверку подлинности реестр Docker (например, в реестр контейнеров Azure), как показано на рис. 5-5.

![Снимок экрана: этап публикации образов в реестре.](./media/docker-application-outer-loop-devops-workflow/publish-custom-image-to-docker-registry.png)

**Рис. 5-5**. Использование служб Azure DevOps Services для публикации пользовательских образов в реестр Docker

> [!TIP]
> Дополнительные сведения о Реестре контейнеров Azure см. на странице <https://aka.ms/azurecontainerregistry>.

## <a name="step-4-cd-deploy"></a>Шаг 4. Непрерывное развертывание и развертывание

Неизменность образов Docker позволяет гарантировать успешное многократное развертывание компонентов, которые разрабатываются, тестируются в рамках процесса непрерывной интеграции и выполняются в рабочей среде. После публикации образов приложений Docker в реестре Docker (закрытом или общедоступном) вы можете развертывать их в разных средах (например, в промежуточной, рабочей среде, среде контроля качества и т. д.) с конвейера непрерывного развертывания с использованием задач конвейера Azure DevOps Services или служб Release Management для Azure DevOps Services.

Выбор подхода зависит от того, какое приложение Docker вы развертываете. Развертывание простого (с точки зрения состава и развертывания), например монолитного, приложения, состоящего из небольшого количества контейнеров и служб, на нескольких серверах или виртуальных машинах будет отличаться от развертывания более сложных приложений, например ориентированных на микрослужбы с возможностями гипермасштабирования. Эти сценарии рассматриваются в следующих разделах.

### <a name="deploying-composed-docker-applications-to-multiple-docker-environments"></a>Развертывание составных приложений Docker в нескольких средах Docker

Для начала рассмотрим более простой сценарий, подразумевающий развертывание на простых узлах Docker (виртуальные машины или серверы) в одной или нескольких средах (промежуточная, рабочая среда или среда контроля качества). В этом сценарии вы можете использовать команду docker-compose (из задач развертывания Azure DevOps Services) внутри конвейера непрерывного развертывания для развертывания приложений Docker и связанных с ними наборов контейнеров и служб, как показано на рис. 5-6.

![Схема, на которой показано развертывание в трех средах в рамках непрерывного развертывания.](./media/docker-application-outer-loop-devops-workflow/deploy-app-containers-to-docker-host-environments.png)

**Рис. 5-6**. Развертывание контейнеров приложений в реестре сред простого узла Docker

На рис. 5-7 показаны принципы подключения непрерывной интеграции сборки к средам контроля качества и тестирования через Azure DevOps Services посредством выбора задачи Docker Compose в диалоговом окне "Добавить задачу". Тем не менее при развертывании в промежуточной или рабочей среде обычно используются возможности служб Release Management, позволяющие работать с несколькими средами (промежуточная, рабочая среда или среда контроля качества). При развертывании на отдельных узлах Docker используется задача Docker Compose служб Azure DevOps Services (внутри этой задачи вызывается команда `docker-compose up`). При развертывании службы Azure Kubernetes (AKS) используется задача развертывания Docker, как описывается в следующем разделе.

![Снимок экрана: диалоговое окно добавления задачи Docker Compose.](./media/docker-application-outer-loop-devops-workflow/add-tasks-docker-compose.png)

**Рис. 5-7**. Добавление задачи Docker Compose на конвейер служб Azure DevOps Services

При создании выпуска в Azure DevOps Services используется набор входных артефактов. Эти артефакты должны быть неизменными на протяжении всего жизненного цикла выпуска во всех средах. При работе с контейнерами входные артефакты определяют развертываемые образы в реестре. В зависимости от способа идентификации этих образов они необязательно будут оставаться неизменными на протяжении всего жизненного цикла выпуска. Самым очевидным примером этого является использование ссылки на `myimage:latest` из файла `docker-compose`.

С помощью шаблонов Azure DevOps Services вы можете создавать артефакты сборки, содержащие дайджесты конкретного образа реестра, которые гарантированно будут уникальным способом определять один и тот же двоичный файл образа. Именно они будут использоваться в качестве входных данных для выпуска.

### <a name="managing-releases-to-docker-environments-by-using-azure-devops-services-release-management"></a>Управление выпусками в средах Docker с использованием служб Release Management для Azure DevOps Services

С помощью шаблонов Azure DevOps Services вы можете создать новый образ, опубликовать его в реестре Docker, запустить его на узлах под управлением Linux или Windows, а также развернуть несколько контейнеров в качестве единого приложения с помощью таких команд, как `docker-compose`. Для решения всех этих задач используются возможности служб Release Management для Azure DevOps Services, обеспечивающие работу с несколькими средами (см. рис. 5-8).

![Снимок экрана, на котором показана конфигурация выпусков Docker Compose.](./media/docker-application-outer-loop-devops-workflow/configure-docker-compose-release.png)

**Рис. 5-8**. Настройка задач Docker Compose в Azure DevOps Services с помощью служб Release Management для Azure DevOps Services

Не забывайте, что сценарий, который показан на рис. 5-6 и реализован на рис. 5-8, является простым (развертывание одного контейнера или экземпляра на каждый образ на отдельных виртуальных машинах или узлах Docker). Как правило, такой сценарий возможен только на этапах разработки или тестирования. В большинстве рабочих корпоративных сред вам потребуется обеспечить высокий уровень доступности и простоту масштабирования посредством балансировки нагрузки между несколькими узлами, серверами и виртуальными машинами, а также возможности интеллектуальной отработки отказа для автоматического переноса служб или контейнеров с отказавшего сервера или узла на другой сервер или другую виртуальную машину. В таком случае вам потребуются более сложные технологии, например кластеры контейнеров, оркестраторы и планировщики. Таким образом, при развертывании в таких кластерах вы будете следовать более сложным сценариям, которые описываются в следующем разделе.

### <a name="deploying-docker-applications-to-docker-clusters"></a>Развертывание приложений Docker в кластерах Docker

По своей природе распределенные приложения требуют распределенных вычислительных ресурсов. Чтобы обеспечить возможности масштабирования для рабочей среды, вам необходимо использовать кластеры, которые обеспечивают высокий уровень доступности и масштабируемости за счет применения пула ресурсов.

Вы можете развернуть контейнеры в таких кластерах вручную с помощью средства командной строки или веб-интерфейса пользователя, однако делать это рекомендуется только при точечных развертываниях, предназначенных для тестирования, либо управления масштабированием или мониторингом.

С точки зрения непрерывного развертывания и, в частности, служб Azure DevOps Services, вы можете использовать специализированные задачи развертывания из служб Release Management для Azure DevOps Services, которые позволяют развертывать контейнерные приложения в распределенных кластерах в службе контейнеров, как показано на рис. 5-9.

![Схема, на которой показано развертывание в оркестраторах в рамках непрерывного развертывания.](./media/docker-application-outer-loop-devops-workflow/cd-deploy-to-orchestrators.png)

**Рис. 5-9**. Развертывание распределенных приложений в службе контейнеров

Изначально для развертывания в определенных кластерах или оркестраторах вам необходимо было использовать особые скрипты и механизмы развертывания для каждого оркестратора (например, Kubernetes и Service Fabric используют разные механизмы развертывания) вместо единой удобной задачи `docker-compose`, которая основывается на файле определения `docker-compose.yml`. Тем не менее благодаря задаче Docker Deploy в Azure DevOps Services (см. рис. 5-10) теперь вы также можете выполнять развертывание в поддерживаемых оркестраторах с использованием знакомого файла `docker-compose.yml`. Это связано с тем, что данное средство автоматически выполняет преобразование из файла `docker-compose.yml` в формат, используемый оркестратором.

![Снимок экрана, на котором показана задача развертывания в Kubernetes.](./media/docker-application-outer-loop-devops-workflow/add-deploy-to-kubernetes-task.png)

**Рис. 5-10**. Добавление в среду задачи развертывания в Kubernetes

На рис. 5-11 показаны возможности для редактирования задачи развертывания в Kubernetes и разделы, которые доступны для настройки. Эта задача будет извлекать в кластер готовые к работе пользовательские образы Docker в виде контейнеров.

![Снимок экрана, на котором показана конфигурация задачи развертывания в Kubernetes.](./media/docker-application-outer-loop-devops-workflow/edit-deploy-to-kubernetes-task.png)

**Рис. 5-11**. Определение задачи Docker Deploy для развертывания в ACS DC/OS

> [!TIP]
> Дополнительные сведения о конвейере непрерывного развертывания для Azure DevOps Services и Docker см. на странице <https://azure.microsoft.com/services/devops/pipelines>.

## <a name="step-5-run-and-manage"></a>Шаг 5. Запуск и управление

Поскольку запуск приложений в рабочей корпоративной среде и управление ими сами по себе являются весьма объемной темой, в связи с характером операций, выполняемых сотрудниками на этом уровне (ИТ-операции), а также из-за большого объема информации по этой теме ей будет посвящена вся следующая глава.

## <a name="step-6-monitor-and-diagnose"></a>Шаг 6. Мониторинг и диагностика

Эта тема также рассматривается в следующей главе в контексте ИТ-операций, выполняемых в рабочих системах. Тем не менее важно отметить, что полученные на этом этапе аналитические сведения должны передаваться команде разработчиков, которая сможет использовать их в качестве основы для постоянного улучшения приложения. С этой точки зрения такие задачи операции также относятся к DevOps, хотя и выполняются в основном ИТ-отделом.

Функции мониторинга и диагностики полностью относятся к сфере DevOps только в том случае, если они выполняются командой разработчиков по отношению к средам тестирования или бета-версиям сред. Для этих целей осуществляются нагрузочное тестирование или мониторинг в бета-версиях сред или средах контроля качества, на которых тестировщики проверяют новые решения.

>[!div class="step-by-step"]
>[Назад](index.md)
>[Вперед](create-ci-cd-pipelines-azure-devops-services-aspnetcore-kubernetes.md)
