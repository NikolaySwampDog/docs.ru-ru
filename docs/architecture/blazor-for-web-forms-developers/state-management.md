---
title: Управление данными о состоянии
description: Сведения о различных подходах к управлению состоянием в ASP.NET Web Forms и Blazor.
author: csharpfritz
ms.author: jefritz
ms.date: 05/15/2020
ms.openlocfilehash: 2ca811f886c6a245ac16c2bd66a68ff16e5bfc44
ms.sourcegitcommit: 05d0087dfca85aac9ca2960f86c5efd218bf833f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/30/2021
ms.locfileid: "88267728"
---
# <a name="state-management"></a><span data-ttu-id="710e4-103">Управление данными о состоянии</span><span class="sxs-lookup"><span data-stu-id="710e4-103">State management</span></span>

<span data-ttu-id="710e4-104">Управление состоянием — это ключевая концепция приложений веб-форм, реализуемая посредством функций состояния просмотра, состояния сеанса, состояния приложения и обратной передачи.</span><span class="sxs-lookup"><span data-stu-id="710e4-104">State management is a key concept of Web Forms applications, facilitated through View State, Session State, Application State, and Postback features.</span></span> <span data-ttu-id="710e4-105">Эти функции с отслеживанием состояния, доступные на данной платформе, помогли скрыть необходимое для приложения управление состоянием и позволяют разработчикам приложений сосредоточиться на их функциональности.</span><span class="sxs-lookup"><span data-stu-id="710e4-105">These stateful features of the framework helped to hide the state management required for an application and allow application developers to focus on delivering their functionality.</span></span> <span data-ttu-id="710e4-106">Для ASP.NET Core и Blazor некоторые из этих функций были перемещены, а некоторые полностью удалены.</span><span class="sxs-lookup"><span data-stu-id="710e4-106">With ASP.NET Core and Blazor, some of these features have been relocated and some have been removed altogether.</span></span> <span data-ttu-id="710e4-107">В этой главе рассматриваются способы сохранения состояния и предоставления тех же функциональных возможностей с помощью новых функций в Blazor.</span><span class="sxs-lookup"><span data-stu-id="710e4-107">This chapter reviews how to maintain state and deliver the same functionality with the new features in Blazor.</span></span>

## <a name="request-state-management-with-viewstate"></a><span data-ttu-id="710e4-108">Запрос на управление состоянием с помощью ViewState</span><span class="sxs-lookup"><span data-stu-id="710e4-108">Request state management with ViewState</span></span>

<span data-ttu-id="710e4-109">При обсуждении управления состоянием в приложении веб-форм многим разработчикам на ум сразу приходит ViewState.</span><span class="sxs-lookup"><span data-stu-id="710e4-109">When discussing state management in Web Forms application, many developers will immediately think of ViewState.</span></span> <span data-ttu-id="710e4-110">В веб-формах ViewState управляет состоянием содержимого между HTTP-запросами, отправляя большой кодированный блок текста вперед и назад в браузер.</span><span class="sxs-lookup"><span data-stu-id="710e4-110">In Web Forms, ViewState manages the state of the content between HTTP requests by sending a large encoded block of text back and forth to the browser.</span></span> <span data-ttu-id="710e4-111">Поле ViewState может быть перегружено содержимым страницы, содержащей множество элементов, в результате чего размер может увеличиться до нескольких мегабайт.</span><span class="sxs-lookup"><span data-stu-id="710e4-111">The ViewState field could be overwhelmed with content from a page containing many elements, potentially expanding to several megabytes in size.</span></span>

<span data-ttu-id="710e4-112">При использовании Blazor Server приложение сохраняет текущее подключение к серверу.</span><span class="sxs-lookup"><span data-stu-id="710e4-112">With Blazor Server, the app maintains an ongoing connection with the server.</span></span> <span data-ttu-id="710e4-113">Состояние приложения, называемое *цепью*, хранится в памяти сервера, пока подключение считается активным.</span><span class="sxs-lookup"><span data-stu-id="710e4-113">The app's state, called a *circuit*, is held in server memory while the connection is considered active.</span></span> <span data-ttu-id="710e4-114">Состояние будет удалено, только когда пользователь покидает приложение или переходит на определенную страницу в нем.</span><span class="sxs-lookup"><span data-stu-id="710e4-114">State will only be disposed when the user navigates away from the app or a particular page in the app.</span></span> <span data-ttu-id="710e4-115">Все члены активных компонентов доступны между взаимодействиями с сервером.</span><span class="sxs-lookup"><span data-stu-id="710e4-115">All members of the active components are available between interactions with the server.</span></span>

<span data-ttu-id="710e4-116">Эта функция имеет несколько преимуществ:</span><span class="sxs-lookup"><span data-stu-id="710e4-116">There are several advantages of this feature:</span></span>

- <span data-ttu-id="710e4-117">Состояние компонента легко доступно и не перестраивается между взаимодействиями.</span><span class="sxs-lookup"><span data-stu-id="710e4-117">Component state is readily available and not rebuilt between interactions.</span></span>
- <span data-ttu-id="710e4-118">Состояние не передается в браузер.</span><span class="sxs-lookup"><span data-stu-id="710e4-118">State isn't transmitted to the browser.</span></span>

<span data-ttu-id="710e4-119">Однако существуют некоторые недостатки сохранения состояния компонента в памяти, которые следует учитывать:</span><span class="sxs-lookup"><span data-stu-id="710e4-119">However, there are some disadvantages to in-memory component state persistence to be aware of:</span></span>

- <span data-ttu-id="710e4-120">Если сервер перезапускается между запросами, состояние теряется.</span><span class="sxs-lookup"><span data-stu-id="710e4-120">If the server restarts between request, state is lost.</span></span>
- <span data-ttu-id="710e4-121">Решение для балансировки нагрузки веб-сервера приложения должно включать в себя прикрепленные сеансы, чтобы все запросы из одного браузера возвращались на один и тот же сервер.</span><span class="sxs-lookup"><span data-stu-id="710e4-121">Your application web server load-balancing solution must include sticky sessions to ensure that all requests from the same browser return to the same server.</span></span> <span data-ttu-id="710e4-122">В случае перехода запроса на другой сервер состояние будет потеряно.</span><span class="sxs-lookup"><span data-stu-id="710e4-122">If a request goes to a different server, state will be lost.</span></span>
- <span data-ttu-id="710e4-123">Сохранение состояния компонента на сервере может привести к нехватке памяти на веб-сервере.</span><span class="sxs-lookup"><span data-stu-id="710e4-123">Persistence of component state on the server can lead to memory pressure on the web server.</span></span>

<span data-ttu-id="710e4-124">По указанным выше причинам не следует полагаться на то, что состояние компонента всегда находится в памяти на сервере.</span><span class="sxs-lookup"><span data-stu-id="710e4-124">For the preceding reasons, don't rely on just the state of the component to reside in-memory on the server.</span></span> <span data-ttu-id="710e4-125">Приложение также должно использовать резервное хранилище данных для размещения данных между запросами.</span><span class="sxs-lookup"><span data-stu-id="710e4-125">Your application should also include some backing data store for data between requests.</span></span> <span data-ttu-id="710e4-126">Вот несколько простых примеров такой стратегии.</span><span class="sxs-lookup"><span data-stu-id="710e4-126">Some simple examples of this strategy:</span></span>

- <span data-ttu-id="710e4-127">В приложении корзины для покупок содержимое новых элементов, добавленных в корзину, сохраняется в записи базы данных.</span><span class="sxs-lookup"><span data-stu-id="710e4-127">In a shopping cart application, persist the content of new items added to the cart in a database record.</span></span> <span data-ttu-id="710e4-128">Если состояние на сервере потеряно, его можно восстановить из записей базы данных.</span><span class="sxs-lookup"><span data-stu-id="710e4-128">If the state on the server is lost, you can reconstitute it from the database records.</span></span>
- <span data-ttu-id="710e4-129">При работе с многокомпонентной веб-формой пользователи ожидают, что ваше приложение запомнит значения между каждым запросом.</span><span class="sxs-lookup"><span data-stu-id="710e4-129">In a multi-part web form, your users will expect your application to remember values between each request.</span></span> <span data-ttu-id="710e4-130">Записывайте данные в хранилище данных между каждой записью пользователя, чтобы их можно было извлечь и собрать в итоговую структуру ответа формы после заполнения многокомпонентной формы.</span><span class="sxs-lookup"><span data-stu-id="710e4-130">Write the data between each of your user's posts to a data store so that they can be fetched and assembled into the final form response structure when the multi-part form is completed.</span></span>

<span data-ttu-id="710e4-131">Дополнительные сведения об управлении состоянием в приложениях Blazor см. в разделе [Управление состоянием Blazor в ASP.NET Core](/aspnet/core/blazor/state-management).</span><span class="sxs-lookup"><span data-stu-id="710e4-131">For additional details on managing state in Blazor apps, see [ASP.NET Core Blazor state management](/aspnet/core/blazor/state-management).</span></span>

## <a name="maintain-state-with-session"></a><span data-ttu-id="710e4-132">Сохранение состояния с помощью сеанса</span><span class="sxs-lookup"><span data-stu-id="710e4-132">Maintain state with Session</span></span>

<span data-ttu-id="710e4-133">Разработчики веб-форм могут сохранять сведения об активном в данный момент пользователе с помощью объекта словаря <xref:Microsoft.AspNetCore.Http.ISession?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="710e4-133">Web Forms developers could maintain information about the currently acting user with the <xref:Microsoft.AspNetCore.Http.ISession?displayProperty=nameWithType> dictionary object.</span></span> <span data-ttu-id="710e4-134">Достаточно просто добавить объект со строковым ключом в `Session`, и этот объект будет доступен позже во время взаимодействия пользователя с приложением.</span><span class="sxs-lookup"><span data-stu-id="710e4-134">It's easy enough to add an object with a string key to the `Session`, and that object would be available at a later time during the user's interactions with the application.</span></span> <span data-ttu-id="710e4-135">Объект `Session` в результате попытки исключить управление взаимодействием с HTTP обеспечил простоту сохранения состояния.</span><span class="sxs-lookup"><span data-stu-id="710e4-135">In an attempt to eliminate managing interacting with HTTP, the `Session` object made it easy to maintain state.</span></span>

<span data-ttu-id="710e4-136">Подпись объекта `Session` платформы .NET Framework не совпадает с подписью объекта `Session` ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="710e4-136">The signature of the .NET Framework `Session` object isn't the same as the ASP.NET Core `Session` object.</span></span> <span data-ttu-id="710e4-137">Изучите [документацию по новому объекту Session ASP.NET Core](/dotnet/api/microsoft.aspnetcore.http.isession), прежде чем принимать решение о переносе и использовании новой функции состояния сеанса.</span><span class="sxs-lookup"><span data-stu-id="710e4-137">Consider [the documentation for the new ASP.NET Core Session](/dotnet/api/microsoft.aspnetcore.http.isession) before deciding to migrate and use the new session state feature.</span></span>

<span data-ttu-id="710e4-138">Сеанс доступен в ASP.NET Core и Blazor Server, однако его не рекомендуется использовать вместо надлежащего сохранения данных в репозитории данных.</span><span class="sxs-lookup"><span data-stu-id="710e4-138">Session is available in ASP.NET Core and Blazor Server, but is discouraged from use in favor of storing data in a data repository appropriately.</span></span> <span data-ttu-id="710e4-139">Состояние сеанса также не работает, если посетители не соглашаются использовать файлы cookie HTTP в приложении из соображений конфиденциальности.</span><span class="sxs-lookup"><span data-stu-id="710e4-139">Session state is also not functional if visitors decline the use HTTP cookies in your application due to privacy concerns.</span></span>

<span data-ttu-id="710e4-140">Конфигурация ASP.NET Core и состояние сеанса приведена в статье [Управление сеансами и состояниями в ASP.NET Core](/aspnet/core/fundamentals/app-state#session-state).</span><span class="sxs-lookup"><span data-stu-id="710e4-140">Configuration for ASP.NET Core and Session state is available in the [Session and state management in ASP.NET Core article](/aspnet/core/fundamentals/app-state#session-state).</span></span>

## <a name="application-state"></a><span data-ttu-id="710e4-141">Состояние приложения</span><span class="sxs-lookup"><span data-stu-id="710e4-141">Application state</span></span>

<span data-ttu-id="710e4-142">Объект `Application` в платформе веб-форм предоставляет обширный и поддерживающий различные запросы репозиторий для взаимодействия с конфигурацией и состоянием, относящимся к области определения приложения.</span><span class="sxs-lookup"><span data-stu-id="710e4-142">The `Application` object in the Web Forms framework provides a massive, cross-request repository for interacting with application-scope configuration and state.</span></span> <span data-ttu-id="710e4-143">Состояние приложения было оптимальным местом для хранения различных свойств конфигурации приложения, на которые могут ссылаться все запросы, независимо от пользователя, выполняющего такой запрос.</span><span class="sxs-lookup"><span data-stu-id="710e4-143">Application state was an ideal place to store various application configuration properties that would be referenced by all requests, regardless of the user making the request.</span></span> <span data-ttu-id="710e4-144">Проблема с объектом `Application` заключается в том, что данные не сохранялись между разными серверами.</span><span class="sxs-lookup"><span data-stu-id="710e4-144">The problem with the `Application` object was that data didn't persist across multiple servers.</span></span> <span data-ttu-id="710e4-145">Состояние объекта приложения терялось между перезапусками.</span><span class="sxs-lookup"><span data-stu-id="710e4-145">The state of the application object was lost between restarts.</span></span>

<span data-ttu-id="710e4-146">Как и в случае с `Session`, рекомендуется перемещать данные в постоянное резервное хранилище, доступное нескольким экземплярам сервера.</span><span class="sxs-lookup"><span data-stu-id="710e4-146">As with `Session`, it's recommended that data move to a persistent backing store that could be accessed by multiple server instances.</span></span> <span data-ttu-id="710e4-147">Если имеются непостоянные данные, к которым вы хотите обеспечить доступ разным запросам и пользователям, можно легко сохранить их в отдельной службе, которую можно внедрить в компоненты, нуждающиеся в такой информации или таком взаимодействии.</span><span class="sxs-lookup"><span data-stu-id="710e4-147">If there is volatile data that you would like to be able to access across requests and users, you could easily store it in a singleton service that can be injected into components that require this information or interaction.</span></span>

<span data-ttu-id="710e4-148">Создание объекта для сохранения состояния приложения и его использование могут напоминать следующую реализацию:</span><span class="sxs-lookup"><span data-stu-id="710e4-148">The construction of an object to maintain application state and its consumption could resemble the following implementation:</span></span>

```csharp
public class MyApplicationState
{
    public int VisitorCounter { get; private set; } = 0;

    public void IncrementCounter() => VisitorCounter += 1;
}
```

```csharp
app.AddSingleton<MyApplicationState>();
```

```razor
@inject MyApplicationState AppState

<label>Total Visitors: @AppState.VisitorCounter</label>
```

<span data-ttu-id="710e4-149">Объект `MyApplicationState` создается на сервере только один раз, и значение `VisitorCounter` извлекается и выводится в метке компонента.</span><span class="sxs-lookup"><span data-stu-id="710e4-149">The `MyApplicationState` object is created only once on the server, and the value `VisitorCounter` is fetched and output in the component's label.</span></span> <span data-ttu-id="710e4-150">Значение `VisitorCounter` должно сохраняться в резервном хранилище данных и извлекаться из него для обеспечения устойчивости и масштабируемости.</span><span class="sxs-lookup"><span data-stu-id="710e4-150">The `VisitorCounter` value should be persisted and retrieved from a backing data store for durability and scalability.</span></span>

## <a name="in-the-browser"></a><span data-ttu-id="710e4-151">В браузере</span><span class="sxs-lookup"><span data-stu-id="710e4-151">In the browser</span></span>

<span data-ttu-id="710e4-152">Данные приложений также могут храниться на стороне клиента, а именно на устройстве пользователя, чтобы они были доступны позже.</span><span class="sxs-lookup"><span data-stu-id="710e4-152">Application data can also be stored client-side on the user's device so that is available later.</span></span> <span data-ttu-id="710e4-153">Существует две функции браузера, позволяющие сохранять данные в разных областях браузера пользователя:</span><span class="sxs-lookup"><span data-stu-id="710e4-153">There are two browser features that allow for persistence of data in different scopes of the user's browser:</span></span>

- <span data-ttu-id="710e4-154">`localStorage` — относится к области всего браузера пользователя.</span><span class="sxs-lookup"><span data-stu-id="710e4-154">`localStorage` - scoped to the user's entire browser.</span></span> <span data-ttu-id="710e4-155">При перезагрузке страницы браузер закрывается и открывается повторно, либо открывается другая вкладка с тем же URL-адресом, после чего та же `localStorage` предоставляется в браузере.</span><span class="sxs-lookup"><span data-stu-id="710e4-155">If the page is reloaded, the browser is closed and reopened, or another tab is opened with the same URL then the same `localStorage` is provided by the browser</span></span>
- <span data-ttu-id="710e4-156">`sessionStorage` — относится к области текущей вкладки браузера пользователя. При перезагрузке вкладки состояние сохраняется.</span><span class="sxs-lookup"><span data-stu-id="710e4-156">`sessionStorage` - scoped to the user's current browser tab. If the tab is reloaded, the state persists.</span></span> <span data-ttu-id="710e4-157">Однако если пользователь откроет другую вкладку для приложения или закроет и снова откроет браузер, состояние будет потеряно.</span><span class="sxs-lookup"><span data-stu-id="710e4-157">However, if the user opens another tab to your application or closes and reopens the browser the state is lost.</span></span>

<span data-ttu-id="710e4-158">Вы можете написать специальный код JavaScript для взаимодействия с этими функциями, кроме того, существует ряд пакетов NuGet, которые можно использовать для предоставления подобных функциональных возможностей.</span><span class="sxs-lookup"><span data-stu-id="710e4-158">You can write some custom JavaScript code to interact with these features, or there are a number of NuGet packages that you can use that provide this functionality.</span></span> <span data-ttu-id="710e4-159">Одним из таких пакетов является [Microsoft.AspNetCore.ProtectedBrowserStorage](https://www.nuget.org/packages/Microsoft.AspNetCore.ProtectedBrowserStorage).</span><span class="sxs-lookup"><span data-stu-id="710e4-159">One such package is [Microsoft.AspNetCore.ProtectedBrowserStorage](https://www.nuget.org/packages/Microsoft.AspNetCore.ProtectedBrowserStorage).</span></span>

<span data-ttu-id="710e4-160">Инструкции по использованию этого пакета для взаимодействия с `localStorage` и `sessionStorage` см. в статье [Управление состоянием Blazor ](/aspnet/core/blazor/state-management#protected-browser-storage-experimental-package).</span><span class="sxs-lookup"><span data-stu-id="710e4-160">For instructions on utilizing this package to interact with `localStorage` and `sessionStorage`, see the [Blazor State Management](/aspnet/core/blazor/state-management#protected-browser-storage-experimental-package) article.</span></span>

>[!div class="step-by-step"]
><span data-ttu-id="710e4-161">[Назад](pages-routing-layouts.md)
>[Вперед](forms-validation.md)</span><span class="sxs-lookup"><span data-stu-id="710e4-161">[Previous](pages-routing-layouts.md)
[Next](forms-validation.md)</span></span>
