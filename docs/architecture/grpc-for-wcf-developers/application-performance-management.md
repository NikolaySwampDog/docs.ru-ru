---
title: Управление производительностью приложений — gRPC для разработчиков WCF
description: Ведение журнала, метрики и трассировка для ASP.NET Core gRPC приложений.
ms.date: 12/15/2020
ms.openlocfilehash: 06515762e3e5febf2d11dea14524d5e3f586a760
ms.sourcegitcommit: c7f0beaa2bd66ebca86362ca17d673f7e8256ca6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/23/2021
ms.locfileid: "104874554"
---
# <a name="application-performance-management"></a><span data-ttu-id="846c0-103">Управление производительностью приложений</span><span class="sxs-lookup"><span data-stu-id="846c0-103">Application Performance Management</span></span>

<span data-ttu-id="846c0-104">В рабочих средах, таких как Kubernetes, важно отслеживать приложения, чтобы обеспечить их оптимальное выполнение.</span><span class="sxs-lookup"><span data-stu-id="846c0-104">In production environments like Kubernetes, it's important to monitor applications to ensure they're running optimally.</span></span> <span data-ttu-id="846c0-105">Журнал и метрики важны в частности.</span><span class="sxs-lookup"><span data-stu-id="846c0-105">Logging and metrics are important in particular.</span></span> <span data-ttu-id="846c0-106">ASP.NET Core, включая gRPC, предоставляет встроенную поддержку для создания сообщений журнала и данных метрик и управления ими, а также для *трассировки* данных.</span><span class="sxs-lookup"><span data-stu-id="846c0-106">ASP.NET Core, including gRPC, provides built-in support for producing and managing log messages and metrics data, as well as *tracing* data.</span></span>

## <a name="the-difference-between-logging-and-metrics"></a><span data-ttu-id="846c0-107">Разница между ведением журнала и метриками</span><span class="sxs-lookup"><span data-stu-id="846c0-107">The difference between logging and metrics</span></span>

<span data-ttu-id="846c0-108">*Ведение журнала* касается текстовых сообщений, которые записывают подробные сведения о том, что произошло в системе.</span><span class="sxs-lookup"><span data-stu-id="846c0-108">*Logging* is concerned with text messages that record detailed information about things that have happened in the system.</span></span> <span data-ttu-id="846c0-109">Сообщения журнала могут содержать данные об исключениях, например трассировки стека, или структурированные данные, предоставляющие контекст сообщения.</span><span class="sxs-lookup"><span data-stu-id="846c0-109">Log messages might include exception data, like stack traces, or structured data that provide context about the message.</span></span> <span data-ttu-id="846c0-110">Вывод журнала обычно записывается в хранилище текста с возможностью поиска.</span><span class="sxs-lookup"><span data-stu-id="846c0-110">Logging output is commonly written to a searchable text store.</span></span>

<span data-ttu-id="846c0-111">*Метрики* — это числовые данные, предназначенные для агрегирования и представления с помощью диаграмм и графиков на панели мониторинга.</span><span class="sxs-lookup"><span data-stu-id="846c0-111">*Metrics* refers to numeric data designed to be aggregated and presented by using charts and graphs in a dashboard.</span></span> <span data-ttu-id="846c0-112">Панель мониторинга предоставляет общее представление о работоспособности и производительности приложения.</span><span class="sxs-lookup"><span data-stu-id="846c0-112">The dashboard provides a view of the overall health and performance of an application.</span></span> <span data-ttu-id="846c0-113">Данные метрик можно также использовать для активации автоматических оповещений при превышении порогового значения.</span><span class="sxs-lookup"><span data-stu-id="846c0-113">Metrics data can also be used to trigger automated alerts when a threshold is exceeded.</span></span> <span data-ttu-id="846c0-114">Ниже приведены некоторые примеры данных метрик.</span><span class="sxs-lookup"><span data-stu-id="846c0-114">Here are some examples of metrics data:</span></span>

- <span data-ttu-id="846c0-115">Время, затраченное на обработку запросов.</span><span class="sxs-lookup"><span data-stu-id="846c0-115">Time taken to process requests.</span></span>
- <span data-ttu-id="846c0-116">Количество запросов в секунду, обрабатываемых экземпляром службы.</span><span class="sxs-lookup"><span data-stu-id="846c0-116">The number of requests per second being handled by an instance of a service.</span></span>
- <span data-ttu-id="846c0-117">Количество неудачных запросов в экземпляре.</span><span class="sxs-lookup"><span data-stu-id="846c0-117">The number of failed requests on an instance.</span></span>

## <a name="logging-in-aspnet-core-grpc"></a><span data-ttu-id="846c0-118">Вход в систему ASP.NET Core gRPC</span><span class="sxs-lookup"><span data-stu-id="846c0-118">Logging in ASP.NET Core gRPC</span></span>

<span data-ttu-id="846c0-119">ASP.NET Core предоставляет встроенную поддержку ведения журнала в виде пакета NuGet [Microsoft. Extensions. Logging](https://www.nuget.org/packages/Microsoft.Extensions.Logging) .</span><span class="sxs-lookup"><span data-stu-id="846c0-119">ASP.NET Core provides built-in support for logging, in the form of [Microsoft.Extensions.Logging](https://www.nuget.org/packages/Microsoft.Extensions.Logging) NuGet package.</span></span> <span data-ttu-id="846c0-120">Основные части этой библиотеки включены в веб-пакет SDK, поэтому нет необходимости устанавливать его вручную.</span><span class="sxs-lookup"><span data-stu-id="846c0-120">The core parts of this library are included with the Web SDK, so there's no need to install it manually.</span></span> <span data-ttu-id="846c0-121">По умолчанию сообщения журнала записываются в стандартный вывод ("консоль") и в любой подключенный отладчик.</span><span class="sxs-lookup"><span data-stu-id="846c0-121">By default, log messages are written to the standard output (the "console") and to any attached debugger.</span></span> <span data-ttu-id="846c0-122">Для записи журналов в постоянные внешние хранилища данных может потребоваться импортировать [Дополнительные пакеты приемника журнала](/aspnet/core/fundamentals/logging/?view=aspnetcore-3.0#third-party-logging-providers).</span><span class="sxs-lookup"><span data-stu-id="846c0-122">To write logs to persistent external data stores, you might need to import [optional logging sink packages](/aspnet/core/fundamentals/logging/?view=aspnetcore-3.0#third-party-logging-providers).</span></span>

<span data-ttu-id="846c0-123">ASP.NET Core gRPC Framework записывает подробные сообщения журнала диагностики в эту платформу ведения журналов, чтобы их можно было обрабатывать и хранить вместе с собственными сообщениями приложения.</span><span class="sxs-lookup"><span data-stu-id="846c0-123">The ASP.NET Core gRPC framework writes detailed diagnostic logging messages to this logging framework, so they can be processed and stored along with your application's own messages.</span></span>

### <a name="produce-log-messages"></a><span data-ttu-id="846c0-124">Создание сообщений журнала</span><span class="sxs-lookup"><span data-stu-id="846c0-124">Produce log messages</span></span>

<span data-ttu-id="846c0-125">Расширение ведения журнала регистрируется автоматически в системе внедрения зависимостей ASP.NET Core, поэтому можно указать средства ведения журнала в качестве параметра конструктора для типов служб gRPC.</span><span class="sxs-lookup"><span data-stu-id="846c0-125">The logging extension is automatically registered with ASP.NET Core's dependency injection system, so you can specify loggers as a constructor parameter on gRPC service types.</span></span>

```csharp
public class StockData : Stocks.StocksBase
{
    private readonly ILogger<StockData> _logger;

    public StockData(ILogger<StockData> logger)
    {
        _logger = logger;
    }
}
```

<span data-ttu-id="846c0-126">Многие сообщения журнала, такие как запросы и исключения, предоставляются компонентами платформы ASP.NET Core и gRPC.</span><span class="sxs-lookup"><span data-stu-id="846c0-126">Many log messages, such as requests and exceptions, are provided by the ASP.NET Core and gRPC framework components.</span></span> <span data-ttu-id="846c0-127">Добавьте собственные сообщения журнала, чтобы предоставить подробные сведения и контекст о логике приложения, а не о проблемах низкого уровня.</span><span class="sxs-lookup"><span data-stu-id="846c0-127">Add your own log messages to provide detail and context about application logic, rather than lower-level concerns.</span></span>

<span data-ttu-id="846c0-128">Дополнительные сведения о написании сообщений журнала и доступных приемников ведения журнала и целевых объектах см.  [в разделе Ведение журнала в .NET Core и ASP.NET Core](/aspnet/core/fundamentals/logging/).</span><span class="sxs-lookup"><span data-stu-id="846c0-128">For more information about writing log messages and available logging sinks and targets, see  [Logging in .NET Core and ASP.NET Core](/aspnet/core/fundamentals/logging/).</span></span>

## <a name="metrics-in-aspnet-core-grpc"></a><span data-ttu-id="846c0-129">Метрики в ASP.NET Core gRPC</span><span class="sxs-lookup"><span data-stu-id="846c0-129">Metrics in ASP.NET Core gRPC</span></span>

<span data-ttu-id="846c0-130">Среда выполнения .NET Core предоставляет набор компонентов для выдачи и наблюдения за метриками.</span><span class="sxs-lookup"><span data-stu-id="846c0-130">The .NET Core runtime provides a set of components for emitting and observing metrics.</span></span> <span data-ttu-id="846c0-131">К ним относятся интерфейсы API, такие как <xref:System.Diagnostics.Tracing.EventSource> <xref:System.Diagnostics.Tracing.EventCounter> классы и.</span><span class="sxs-lookup"><span data-stu-id="846c0-131">These include APIs such as the <xref:System.Diagnostics.Tracing.EventSource> and <xref:System.Diagnostics.Tracing.EventCounter> classes.</span></span> <span data-ttu-id="846c0-132">Эти API-интерфейсы могут выдавать базовые числовые данные, которые могут использоваться внешними процессами, например, [глобальным инструментом DotNet-Counters](../../core/diagnostics/dotnet-counters.md)или трассировкой событий для Windows.</span><span class="sxs-lookup"><span data-stu-id="846c0-132">These APIs can emit basic numeric data that can be consumed by external processes, like the [dotnet-counters global tool](../../core/diagnostics/dotnet-counters.md), or Event Tracing for Windows.</span></span> <span data-ttu-id="846c0-133">Дополнительные сведения об использовании `EventCounter` в собственном коде см. в разделе [евенткаунтер введение](https://github.com/dotnet/runtime/blob/main/src/libraries/System.Diagnostics.Tracing/documentation/EventCounterTutorial.md).</span><span class="sxs-lookup"><span data-stu-id="846c0-133">For more information about using `EventCounter` in your own code, see [EventCounter introduction](https://github.com/dotnet/runtime/blob/main/src/libraries/System.Diagnostics.Tracing/documentation/EventCounterTutorial.md).</span></span>

<span data-ttu-id="846c0-134">Для более сложных метрик и для записи данных метрик в более широкий спектр хранилищ данных можно попробовать проект с открытым исходным кодом, именуемый [метриками приложения](https://www.app-metrics.io).</span><span class="sxs-lookup"><span data-stu-id="846c0-134">For more advanced metrics and for writing metric data to a wider range of data stores, you might try an open-source project called [App Metrics](https://www.app-metrics.io).</span></span> <span data-ttu-id="846c0-135">Этот набор библиотек предоставляет обширный набор типов для инструментирования кода.</span><span class="sxs-lookup"><span data-stu-id="846c0-135">This suite of libraries provides an extensive set of types to instrument your code.</span></span> <span data-ttu-id="846c0-136">Он также предоставляет пакеты для записи метрик в различные типы целевых объектов, которые включают базы данных временных рядов, такие как Prometheus и InfluxDB, и [Application Insights](/azure/azure-monitor/app/app-insights-overview).</span><span class="sxs-lookup"><span data-stu-id="846c0-136">It also offers packages to write metrics to different kinds of targets that include time-series databases, such as Prometheus and InfluxDB, and [Application Insights](/azure/azure-monitor/app/app-insights-overview).</span></span> <span data-ttu-id="846c0-137">Пакет NuGet [app. Metrics. AspNetCore. MVC](https://www.nuget.org/packages/App.Metrics.AspNetCore.Mvc/) даже добавляет всеобъемлющий набор базовых метрик, которые автоматически создаются с помощью интеграции с ASP.NET Core Framework.</span><span class="sxs-lookup"><span data-stu-id="846c0-137">The [App.Metrics.AspNetCore.Mvc](https://www.nuget.org/packages/App.Metrics.AspNetCore.Mvc/) NuGet package even adds a comprehensive set of basic metrics that are automatically generated via integration with the ASP.NET Core framework.</span></span> <span data-ttu-id="846c0-138">Веб-сайт проекта содержит [шаблоны](https://www.app-metrics.io/samples/grafana/) для отображения этих метрик с помощью платформы визуализации [Grafana](https://grafana.com/) .</span><span class="sxs-lookup"><span data-stu-id="846c0-138">The project website provides [templates](https://www.app-metrics.io/samples/grafana/) for displaying those metrics with the [Grafana](https://grafana.com/) visualization platform.</span></span>

### <a name="produce-metrics"></a><span data-ttu-id="846c0-139">Создание метрик</span><span class="sxs-lookup"><span data-stu-id="846c0-139">Produce metrics</span></span>

<span data-ttu-id="846c0-140">Большинство платформ метрик поддерживают следующие типы:</span><span class="sxs-lookup"><span data-stu-id="846c0-140">Most metrics platforms support the following types:</span></span>

| <span data-ttu-id="846c0-141">Тип метрики</span><span class="sxs-lookup"><span data-stu-id="846c0-141">Metric type</span></span> | <span data-ttu-id="846c0-142">Описание</span><span class="sxs-lookup"><span data-stu-id="846c0-142">Description</span></span> |
| ----------- | ----------- |
| <span data-ttu-id="846c0-143">Счетчик</span><span class="sxs-lookup"><span data-stu-id="846c0-143">Counter</span></span>     | <span data-ttu-id="846c0-144">Отслеживает, как часто происходит нечто, например запросы и ошибки.</span><span class="sxs-lookup"><span data-stu-id="846c0-144">Tracks how often something happens, such as requests and errors.</span></span> |
| <span data-ttu-id="846c0-145">Датчик</span><span class="sxs-lookup"><span data-stu-id="846c0-145">Gauge</span></span>       | <span data-ttu-id="846c0-146">Записывает одно значение, которое изменяется со временем, например активные соединения.</span><span class="sxs-lookup"><span data-stu-id="846c0-146">Records a single value that changes over time, such as active connections.</span></span> |
| <span data-ttu-id="846c0-147">Гистограмма</span><span class="sxs-lookup"><span data-stu-id="846c0-147">Histogram</span></span>   | <span data-ttu-id="846c0-148">Измеряет распределение значений по произвольным ограничениям.</span><span class="sxs-lookup"><span data-stu-id="846c0-148">Measures a distribution of values across arbitrary limits.</span></span> <span data-ttu-id="846c0-149">Например, гистограмма может отформатировать размер набора данных, подсчитать, сколько содержалось <10 записей, сколько содержало 11-100 записей, сколько содержало записей 101-1000, а сколько со>1000 записей.</span><span class="sxs-lookup"><span data-stu-id="846c0-149">For example, a histogram can track dataset size, counting how many contained <10 records, how many contained 11-100 records, how many contained 101-1000 records, and how many contained >1000 records.</span></span> |
| <span data-ttu-id="846c0-150">средство измерения.</span><span class="sxs-lookup"><span data-stu-id="846c0-150">Meter</span></span>       | <span data-ttu-id="846c0-151">Измеряет скорость, с которой событие происходит в различные промежутки времени.</span><span class="sxs-lookup"><span data-stu-id="846c0-151">Measures the rate at which an event occurs in various time spans.</span></span> |
| <span data-ttu-id="846c0-152">Таймер</span><span class="sxs-lookup"><span data-stu-id="846c0-152">Timer</span></span>       | <span data-ttu-id="846c0-153">Отслеживает длительность событий и скорость их возникновения, хранящуюся в виде гистограммы.</span><span class="sxs-lookup"><span data-stu-id="846c0-153">Tracks the duration of events and the rate at which it occurs, stored as a histogram.</span></span> |

<span data-ttu-id="846c0-154">С помощью *метрик приложения* `IMetrics` интерфейс можно получить с помощью внедрения зависимостей и использовать для записи любой из этих метрик для службы gRPC.</span><span class="sxs-lookup"><span data-stu-id="846c0-154">By using *App Metrics*, an `IMetrics` interface can be obtained via dependency injection, and used to record any of these metrics for a gRPC service.</span></span> <span data-ttu-id="846c0-155">В следующем примере показано, как подсчитать количество `Get` запросов, выполненных с течением времени:</span><span class="sxs-lookup"><span data-stu-id="846c0-155">The following example shows how to count the number of `Get` requests made over time:</span></span>

```csharp
public class StockData : Stocks.StocksBase
{
    private static readonly CounterOptions GetRequestCounter = new CounterOptions
    {
        Name = "StockData_Get_Requests",
        MeasurementUnit = Unit.Calls
    };

    private readonly IStockRepository _repository;
    private readonly IMetrics _metrics;

    public StockData(IStockRepository repository, IMetrics metrics)
    {
        _repository = repository;
        _metrics = metrics;
    }

    public override async Task<GetResponse> Get(GetRequest request, ServerCallContext context)
    {
        _metrics.Measure.Counter.Increment(GetRequestCounter);

        // Serve request...
    }
}
```

### <a name="store-and-visualize-metrics-data"></a><span data-ttu-id="846c0-156">Хранение и визуализация данных метрик</span><span class="sxs-lookup"><span data-stu-id="846c0-156">Store and visualize metrics data</span></span>

<span data-ttu-id="846c0-157">Лучшим способом хранения данных метрик является *база данных временных рядов*, специализированное хранилище данных, предназначенное для записи числовых рядов данных, помеченных метками времени.</span><span class="sxs-lookup"><span data-stu-id="846c0-157">The best way to store metrics data is in a *time-series database*, a specialized data store designed to record numerical data series marked with timestamps.</span></span> <span data-ttu-id="846c0-158">Самыми популярными из этих баз данных являются [Prometheus](https://prometheus.io/) и [InfluxDB](https://www.influxdata.com/products/influxdb-overview/).</span><span class="sxs-lookup"><span data-stu-id="846c0-158">The most popular of these databases are [Prometheus](https://prometheus.io/) and [InfluxDB](https://www.influxdata.com/products/influxdb-overview/).</span></span> <span data-ttu-id="846c0-159">Microsoft Azure также предоставляет хранилище выделенных метрик через службу [Azure Monitor](/azure/azure-monitor/overview) .</span><span class="sxs-lookup"><span data-stu-id="846c0-159">Microsoft Azure also provides dedicated metrics storage through the [Azure Monitor](/azure/azure-monitor/overview) service.</span></span>

<span data-ttu-id="846c0-160">Текущим решением для визуализации данных метрик является [Grafana](https://grafana.com), которое работает с широким спектром поставщиков хранилища.</span><span class="sxs-lookup"><span data-stu-id="846c0-160">The current go-to solution for visualizing metrics data is [Grafana](https://grafana.com), which works with a wide range of storage providers.</span></span> <span data-ttu-id="846c0-161">На следующем рисунке показан пример панели мониторинга Grafana, отображающей метрики из сетки службы Linkerd с примером Стоккдата:</span><span class="sxs-lookup"><span data-stu-id="846c0-161">The following image shows an example Grafana dashboard that displays metrics from the Linkerd service mesh running the StockData sample:</span></span>

![Снимок экрана панели мониторинга Grafana](media/application-performance-management/grafana-screenshot.png)

### <a name="metrics-based-alerting"></a><span data-ttu-id="846c0-163">Оповещения на основе метрик</span><span class="sxs-lookup"><span data-stu-id="846c0-163">Metrics-based alerting</span></span>

<span data-ttu-id="846c0-164">Числовой характер данных метрик означает, что он идеально подходит для создания систем предупреждений, уведомления разработчиков или инженеров технической поддержки, когда значение выходит за пределы определенного периода.</span><span class="sxs-lookup"><span data-stu-id="846c0-164">The numerical nature of metrics data means that it's ideally suited to drive alerting systems, notifying developers or support engineers when a value falls outside of some defined tolerance.</span></span> <span data-ttu-id="846c0-165">Уже упомянутые платформы обеспечивают поддержку предупреждений с помощью различных параметров, включая сообщения электронной почты, текстовые сообщения или визуализации панелей мониторинга.</span><span class="sxs-lookup"><span data-stu-id="846c0-165">The platforms already mentioned all provide support for alerting via a range of options, including emails, text messages, or in-dashboard visualizations.</span></span>

## <a name="distributed-tracing"></a><span data-ttu-id="846c0-166">Распределенная трассировка</span><span class="sxs-lookup"><span data-stu-id="846c0-166">Distributed tracing</span></span>

<span data-ttu-id="846c0-167">Распределенная трассировка — это относительно недавняя разработка в мониторинге, которая возникли сомнения от увеличения использования микрослужб и распределенных архитектур.</span><span class="sxs-lookup"><span data-stu-id="846c0-167">Distributed tracing is a relatively recent development in monitoring, which has arisen from the increasing use of microservices and distributed architectures.</span></span> <span data-ttu-id="846c0-168">Один запрос от клиентского браузера, приложения или устройства может быть разбит на несколько шагов и подзапросов, что требует использования множества служб в сети.</span><span class="sxs-lookup"><span data-stu-id="846c0-168">A single request from a client browser, application, or device can be broken down into many steps and sub-requests, and involve the use of many services across a network.</span></span> <span data-ttu-id="846c0-169">Это действие затрудняет сопоставление сообщений журнала и метрик с конкретным запросом, который их инициировал.</span><span class="sxs-lookup"><span data-stu-id="846c0-169">This activity makes it difficult to correlate log messages and metrics with the specific request that triggered them.</span></span> <span data-ttu-id="846c0-170">Распределенная трассировка применяет идентификаторы к запросам и позволяет сопоставлять журналы и метрики с определенной операцией.</span><span class="sxs-lookup"><span data-stu-id="846c0-170">Distributed tracing applies identifiers to requests, and allows logs and metrics to be correlated with a particular operation.</span></span> <span data-ttu-id="846c0-171">Эта трассировка похожа на [сквозную трассировку WCF](../../framework/wcf/diagnostics/tracing/end-to-end-tracing.md), но применяется на нескольких платформах.</span><span class="sxs-lookup"><span data-stu-id="846c0-171">This tracing is similar to [WCF's end-to-end tracing](../../framework/wcf/diagnostics/tracing/end-to-end-tracing.md), but it's applied across multiple platforms.</span></span>

<span data-ttu-id="846c0-172">Распределенная трассировка быстро увеличилась в популярности и начинается стандартизации.</span><span class="sxs-lookup"><span data-stu-id="846c0-172">Distributed tracing has grown quickly in popularity and is beginning to standardize.</span></span> <span data-ttu-id="846c0-173">Облачная инфраструктура машинного кода создала [открытый стандарт трассировки](https://opentracing.io), пытаясь предоставить независимые от поставщика библиотеки для работы с серверными элементами, такими как [жаежер](https://www.jaegertracing.io/) и [эластичная APM](https://www.elastic.co/products/apm).</span><span class="sxs-lookup"><span data-stu-id="846c0-173">The Cloud Native Computing Foundation created the [Open Tracing standard](https://opentracing.io), attempting to provide vendor-neutral libraries for working with back ends like [Jaeger](https://www.jaegertracing.io/) and [Elastic APM](https://www.elastic.co/products/apm).</span></span> <span data-ttu-id="846c0-174">В то же время Google создал [проект опенценсус](https://opencensus.io/) для решения того же набора проблем.</span><span class="sxs-lookup"><span data-stu-id="846c0-174">At the same time, Google created the [OpenCensus project](https://opencensus.io/) to address the same set of problems.</span></span> <span data-ttu-id="846c0-175">Эти два проекта объединяются в новый проект, [опентелеметри](https://opentelemetry.io), который является отраслевым стандартом будущего.</span><span class="sxs-lookup"><span data-stu-id="846c0-175">These two projects are merging into a new project, [OpenTelemetry](https://opentelemetry.io), which aims to be the industry standard of the future.</span></span>

### <a name="how-distributed-tracing-works"></a><span data-ttu-id="846c0-176">Как работает Распределенная трассировка</span><span class="sxs-lookup"><span data-stu-id="846c0-176">How distributed tracing works</span></span>

<span data-ttu-id="846c0-177">Распределенная трассировка основана на концепции *диапазонов*: именованных, временных операций, которые являются частью одной *трассировки*, которая может включать обработку на нескольких узлах системы.</span><span class="sxs-lookup"><span data-stu-id="846c0-177">Distributed tracing is based on the concept of *spans*: named, timed operations that are part of a single *trace*, which can involve processing on multiple nodes of a system.</span></span> <span data-ttu-id="846c0-178">При запуске новой операции создается трассировка с уникальным идентификатором.</span><span class="sxs-lookup"><span data-stu-id="846c0-178">When a new operation is initiated, a trace is created with a unique identifier.</span></span> <span data-ttu-id="846c0-179">Для каждой вложенной операции создается диапазон с собственным идентификатором и идентификатором трассировки.</span><span class="sxs-lookup"><span data-stu-id="846c0-179">For each sub-operation, a span is created with its own identifier and trace identifier.</span></span> <span data-ttu-id="846c0-180">По мере прохождения запроса вокруг системы различные компоненты могут создавать *дочерние* диапазоны, включающие идентификатор своего *родителя*.</span><span class="sxs-lookup"><span data-stu-id="846c0-180">As the request passes around the system, various components can create *child* spans that include the identifier of their *parent*.</span></span> <span data-ttu-id="846c0-181">Диапазон имеет *контекст*, который содержит идентификаторы трассировки и диапазонов, а также полезные данные в виде пар "ключ — значение" (называется *багажа*).</span><span class="sxs-lookup"><span data-stu-id="846c0-181">A span has a *context*, which contains the trace and span identifiers, as well as useful data in the form of key and value pairs (called *baggage*).</span></span>

### <a name="distributed-tracing-with-diagnosticsource"></a><span data-ttu-id="846c0-182">Распределенная трассировка с помощью `DiagnosticSource`</span><span class="sxs-lookup"><span data-stu-id="846c0-182">Distributed tracing with `DiagnosticSource`</span></span>

<span data-ttu-id="846c0-183">.NET имеет внутренний модуль, который хорошо сопоставляется с распределенными трассировками и охватывает диапазоны: [DiagnosticSource](https://github.com/dotnet/runtime/blob/main/src/libraries/System.Diagnostics.DiagnosticSource/src/DiagnosticSourceUsersGuide.md#diagnosticsource-users-guide).</span><span class="sxs-lookup"><span data-stu-id="846c0-183">.NET has an internal module that maps well to distributed traces and spans: [DiagnosticSource](https://github.com/dotnet/runtime/blob/main/src/libraries/System.Diagnostics.DiagnosticSource/src/DiagnosticSourceUsersGuide.md#diagnosticsource-users-guide).</span></span> <span data-ttu-id="846c0-184">Кроме простого способа создания и использования диагностики внутри процесса, `DiagnosticSource` модуль имеет концепцию *действия*.</span><span class="sxs-lookup"><span data-stu-id="846c0-184">As well as providing a simple way to produce and consume diagnostics within a process, the `DiagnosticSource` module has the concept of an *activity*.</span></span> <span data-ttu-id="846c0-185">Действие фактически является реализацией распределенной трассировки или диапазоном в трассировке.</span><span class="sxs-lookup"><span data-stu-id="846c0-185">An activity is effectively an implementation of a distributed trace, or a span within a trace.</span></span> <span data-ttu-id="846c0-186">Внутренние компоненты модуля принимают на себя действия родительских и дочерних элементов, включая выделение идентификаторов.</span><span class="sxs-lookup"><span data-stu-id="846c0-186">The internals of the module take care of parent/child activities, including allocating identifiers.</span></span> <span data-ttu-id="846c0-187">Дополнительные сведения об использовании `Activity` типа см. в разделе [действие пользователя в GitHub](https://github.com/dotnet/runtime/blob/main/src/libraries/System.Diagnostics.DiagnosticSource/src/ActivityUserGuide.md#activity-user-guide).</span><span class="sxs-lookup"><span data-stu-id="846c0-187">For more information about using the `Activity` type, see the [Activity User Guide on GitHub](https://github.com/dotnet/runtime/blob/main/src/libraries/System.Diagnostics.DiagnosticSource/src/ActivityUserGuide.md#activity-user-guide).</span></span>

<span data-ttu-id="846c0-188">Поскольку `DiagnosticSource` является частью основной платформы и более поздних версий, она поддерживается несколькими основными компонентами.</span><span class="sxs-lookup"><span data-stu-id="846c0-188">Because `DiagnosticSource` is a part of the core framework and later, it's supported by several core components.</span></span> <span data-ttu-id="846c0-189">К ним относятся <xref:System.Net.Http.HttpClient> , Entity Framework Core и ASP.NET Core, включая явную поддержку в gRPC Framework.</span><span class="sxs-lookup"><span data-stu-id="846c0-189">These include <xref:System.Net.Http.HttpClient>, Entity Framework Core, and ASP.NET Core, including explicit support in the gRPC framework.</span></span> <span data-ttu-id="846c0-190">Когда ASP.NET Core получает запрос, он проверяет наличие пары HTTP-заголовков, соответствующих стандарту [контекста трассировки W3C](https://www.w3.org/TR/trace-context) .</span><span class="sxs-lookup"><span data-stu-id="846c0-190">When ASP.NET Core receives a request, it checks for a pair of HTTP headers matching the [W3C Trace Context](https://www.w3.org/TR/trace-context) standard.</span></span> <span data-ttu-id="846c0-191">Если заголовки найдены, действие запускается с использованием значений идентификаторов и контекста из заголовков.</span><span class="sxs-lookup"><span data-stu-id="846c0-191">If the headers are found, an activity is started by using the identity values and context from the headers.</span></span> <span data-ttu-id="846c0-192">Если заголовки не найдены, действие запускается с созданными значениями идентификаторов, которые соответствуют стандартному формату.</span><span class="sxs-lookup"><span data-stu-id="846c0-192">If no headers are found, an activity is started with generated identity values that match the standard format.</span></span> <span data-ttu-id="846c0-193">Любая диагностика, создаваемая платформой или кодом приложения в течение времени существования этого действия, может быть помечена идентификаторами трассировки и диапазона.</span><span class="sxs-lookup"><span data-stu-id="846c0-193">Any diagnostics generated by the framework or by application code during the lifetime of this activity can be tagged with the trace and span identifiers.</span></span> <span data-ttu-id="846c0-194">`HttpClient`Поддержка этой функции расширяется за счет проверки текущего действия при каждом запросе и автоматического добавления заголовков трассировки к исходящему запросу.</span><span class="sxs-lookup"><span data-stu-id="846c0-194">The `HttpClient` support extends this functionality further by checking for a current activity on every request, and automatically adding the trace headers to the outgoing request.</span></span>

<span data-ttu-id="846c0-195">Клиентские и серверные библиотеки ASP.NET Core gRPC включают в себя явную поддержку и и создание действий, а также `DiagnosticSource` `Activity` Автоматическое применение и использование сведений о заголовках.</span><span class="sxs-lookup"><span data-stu-id="846c0-195">The ASP.NET Core gRPC client and server libraries include explicit support for `DiagnosticSource` and `Activity`, and create activities and apply and use header information automatically.</span></span>

> [!NOTE]
> <span data-ttu-id="846c0-196">Все это происходит только в том случае, если прослушиватель использует диагностические данные.</span><span class="sxs-lookup"><span data-stu-id="846c0-196">All of this happens only if a listener is consuming the diagnostic information.</span></span> <span data-ttu-id="846c0-197">Если прослушиватель отсутствует, диагностика не записывается и действия не создаются.</span><span class="sxs-lookup"><span data-stu-id="846c0-197">If there's no listener, no diagnostics are written and no activities are created.</span></span>

### <a name="add-your-own-diagnosticsource-and-activity"></a><span data-ttu-id="846c0-198">Добавьте собственные `DiagnosticSource` и `Activity`</span><span class="sxs-lookup"><span data-stu-id="846c0-198">Add your own `DiagnosticSource` and `Activity`</span></span>

<span data-ttu-id="846c0-199">Чтобы добавить собственную диагностику или создать явные диапазоны в коде приложения, ознакомьтесь с руководством [пользователя DiagnosticSource](https://github.com/dotnet/runtime/blob/main/src/libraries/System.Diagnostics.DiagnosticSource/src/DiagnosticSourceUsersGuide.md#instrumenting-with-diagnosticsourcediagnosticlistener) и сведениями о [действии](https://github.com/dotnet/runtime/blob/main/src/libraries/System.Diagnostics.DiagnosticSource/src/ActivityUserGuide.md#activity-usage).</span><span class="sxs-lookup"><span data-stu-id="846c0-199">To add your own diagnostics or create explicit spans within your application code, see the [DiagnosticSource User Guide](https://github.com/dotnet/runtime/blob/main/src/libraries/System.Diagnostics.DiagnosticSource/src/DiagnosticSourceUsersGuide.md#instrumenting-with-diagnosticsourcediagnosticlistener) and [Activity User Guide](https://github.com/dotnet/runtime/blob/main/src/libraries/System.Diagnostics.DiagnosticSource/src/ActivityUserGuide.md#activity-usage).</span></span>

### <a name="store-distributed-trace-data"></a><span data-ttu-id="846c0-200">Хранение распределенных данных трассировки</span><span class="sxs-lookup"><span data-stu-id="846c0-200">Store distributed trace data</span></span>

<span data-ttu-id="846c0-201">На момент написания статьи проект Опентелеметри по-прежнему находится на ранних стадиях, и для приложений .NET доступны только пакеты с альфа-качеством.</span><span class="sxs-lookup"><span data-stu-id="846c0-201">At the time of writing, the OpenTelemetry project is still in the early stages, and only alpha-quality packages are available for .NET applications.</span></span> <span data-ttu-id="846c0-202">В настоящее время проект ОпентраЦинг предлагает более зрелые библиотеки.</span><span class="sxs-lookup"><span data-stu-id="846c0-202">The OpenTracing project currently offers more mature libraries.</span></span>

<span data-ttu-id="846c0-203">API ОпентраЦинг описывается в следующем разделе.</span><span class="sxs-lookup"><span data-stu-id="846c0-203">The OpenTracing API is described in the following section.</span></span> <span data-ttu-id="846c0-204">Если вместо этого вы хотите использовать API Опентелеметри в приложении, обратитесь к [репозиторию пакета SDK для опентелеметри .NET](https://github.com/open-telemetry/opentelemetry-dotnet) на сайте GitHub.</span><span class="sxs-lookup"><span data-stu-id="846c0-204">If you want to use the OpenTelemetry API in your application instead, refer to the [OpenTelemetry .NET SDK repository](https://github.com/open-telemetry/opentelemetry-dotnet) on GitHub.</span></span>

#### <a name="use-the-opentracing-package-to-store-distributed-trace-data"></a><span data-ttu-id="846c0-205">Использование пакета ОпентраЦинг для хранения распределенных данных трассировки</span><span class="sxs-lookup"><span data-stu-id="846c0-205">Use the OpenTracing package to store distributed trace data</span></span>

<span data-ttu-id="846c0-206">[Пакет NuGet опентраЦинг](https://www.nuget.org/packages/OpenTracing/) поддерживает все серверные конечные точки, соответствующие опентраЦинг (которые могут использоваться независимо от `DiagnosticSource` ).</span><span class="sxs-lookup"><span data-stu-id="846c0-206">The [OpenTracing NuGet package](https://www.nuget.org/packages/OpenTracing/) supports all OpenTracing-compliant back ends (which can be used independently of `DiagnosticSource`).</span></span> <span data-ttu-id="846c0-207">Существует дополнительный пакет из проекта публикаций ОпентраЦинг API, [опентраЦинг. от участников сообщества. NetCore](https://www.nuget.org/packages/OpenTracing.Contrib.NetCore/).</span><span class="sxs-lookup"><span data-stu-id="846c0-207">There's an additional package from the OpenTracing API Contributions project, [OpenTracing.Contrib.NetCore](https://www.nuget.org/packages/OpenTracing.Contrib.NetCore/).</span></span> <span data-ttu-id="846c0-208">Этот пакет добавляет `DiagnosticSource` прослушиватель и автоматически записывает события и действия в серверную части.</span><span class="sxs-lookup"><span data-stu-id="846c0-208">This package adds a `DiagnosticSource` listener, and writes events and activities to a back end automatically.</span></span> <span data-ttu-id="846c0-209">Включить этот пакет так же просто, как установить его из NuGet и добавить в качестве службы в `Startup` класс.</span><span class="sxs-lookup"><span data-stu-id="846c0-209">Enabling this package is as simple as installing it from NuGet and adding it as a service in your `Startup` class.</span></span>

```csharp
public class Startup
{
    public void ConfigureServices(IServiceCollection services)
    {
        services.AddOpenTracing();
    }
}
```

<span data-ttu-id="846c0-210">Пакет ОпентраЦинг является уровнем абстракции, и поэтому он требует реализации, характерной для серверной части.</span><span class="sxs-lookup"><span data-stu-id="846c0-210">The OpenTracing package is an abstraction layer, and as such it requires implementation specific to the back end.</span></span> <span data-ttu-id="846c0-211">Реализации API ОпентраЦинг доступны для следующих серверных интерфейсов с открытым исходным кодом.</span><span class="sxs-lookup"><span data-stu-id="846c0-211">OpenTracing API implementations are available for the following open source back ends.</span></span>

| <span data-ttu-id="846c0-212">Имя</span><span class="sxs-lookup"><span data-stu-id="846c0-212">Name</span></span> | <span data-ttu-id="846c0-213">Пакет</span><span class="sxs-lookup"><span data-stu-id="846c0-213">Package</span></span> | <span data-ttu-id="846c0-214">Веб-сайт</span><span class="sxs-lookup"><span data-stu-id="846c0-214">Website</span></span> |
| ---- | ------- | -------- |
| <span data-ttu-id="846c0-215">Jaeger</span><span class="sxs-lookup"><span data-stu-id="846c0-215">Jaeger</span></span> | [<span data-ttu-id="846c0-216">Jaeger</span><span class="sxs-lookup"><span data-stu-id="846c0-216">Jaeger</span></span>](https://www.nuget.org/packages/Jaeger/) | [<span data-ttu-id="846c0-217">jaegertracing.io</span><span class="sxs-lookup"><span data-stu-id="846c0-217">jaegertracing.io</span></span>](https://jaegertracing.io) |
| <span data-ttu-id="846c0-218">Эластичная APM</span><span class="sxs-lookup"><span data-stu-id="846c0-218">Elastic APM</span></span> | [<span data-ttu-id="846c0-219">Эластичный. APM. Неткореалл</span><span class="sxs-lookup"><span data-stu-id="846c0-219">Elastic.Apm.NetCoreAll</span></span>](https://www.nuget.org/packages/Elastic.Apm.NetCoreAll/) | [<span data-ttu-id="846c0-220">elastic.co/products/apm</span><span class="sxs-lookup"><span data-stu-id="846c0-220">elastic.co/products/apm</span></span>](https://www.elastic.co/products/apm) |

<span data-ttu-id="846c0-221">Дополнительные сведения об API ОпентраЦинг для .NET см. в разделе [опентраЦинг for c#](https://github.com/opentracing/opentracing-csharp) и [опентраЦинг от участников сообщества c#/.NET Core](https://github.com/opentracing-contrib/csharp-netcore) репозитории на сайте GitHub.</span><span class="sxs-lookup"><span data-stu-id="846c0-221">For more information on the OpenTracing API for .NET, see the [OpenTracing for C#](https://github.com/opentracing/opentracing-csharp) and the [OpenTracing Contrib C#/.NET Core](https://github.com/opentracing-contrib/csharp-netcore) repositories on GitHub.</span></span>

>[!div class="step-by-step"]
><span data-ttu-id="846c0-222">[Назад](load-balancing.md)
>[Вперед](appendix.md)</span><span class="sxs-lookup"><span data-stu-id="846c0-222">[Previous](load-balancing.md)
[Next](appendix.md)</span></span>
